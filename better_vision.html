<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视力表提升裸眼</title>
    <style>
        /* --- 全局样式 --- */
        :root {
            --blue-500: #3b82f6; --blue-600: #2563eb;
            --green-500: #22c55e; --green-600: #16a34a;
            --purple-500: #a855f7; --purple-600: #9333ea;
            --gray-500: #6b7280; --gray-600: #4b5563; --gray-700: #374151;
            --yellow-500: #eab308; --yellow-600: #ca8a04;
            --red-500: #ef4444; --red-600: #dc2626;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-300: #d1d5db;
            --white: #ffffff; --black: #000000;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: var(--gray-50);
            color: #333;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- 新增：全局返回按钮样式 --- */
        .global-back-button {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100; /* 确保在最上层，高于弹窗(50) */
            padding: 0.5rem 1rem;
            background-color: var(--gray-600);
            color: var(--white);
            text-decoration: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease;
        }
        .global-back-button:hover {
            background-color: var(--gray-700);
        }

        /* --- 页面容器 --- */
        .page {
            display: none;
            min-height: 100vh;
            width: 100%;
            box-sizing: border-box;
        }
        .page.active {
            display: flex;
            flex-direction: column;
        }
        
        /* --- 主页样式 --- */
        #page-home {
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        #page-home h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--gray-700);
            margin-bottom: 3rem;
        }
        .home-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            width: 100%;
            max-width: 48rem;
        }
        @media (max-width: 640px) {
            .home-grid { grid-template-columns: 1fr; }
            .home-grid .btn { grid-column: 1 / -1; }
        }
        @media (min-width: 768px) {
            #page-home h1 { font-size: 3rem; }
        }

        /* --- 按钮样式 --- */
        .btn {
            padding: 1.5rem;
            color: var(--white);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 600;
            text-decoration: none;
        }
        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
        }
        .btn-blue { background-color: var(--blue-500); }
        .btn-blue:hover { background-color: var(--blue-600); }
        .btn-green { background-color: var(--green-500); }
        .btn-green:hover { background-color: var(--green-600); }
        .btn-purple { background-color: var(--purple-500); }
        .btn-purple:hover { background-color: var(--purple-600); }
        .btn-gray { background-color: var(--gray-500); }
        .btn-gray:hover { background-color: var(--gray-600); }
        .btn-red { background-color: var(--red-500); }
        .btn-red:hover { background-color: var(--red-600); }

        .btn svg {
            margin-right: 0.75rem;
            width: 24px;
            height: 24px;
        }

        /* --- 内容页 & Prose 样式 --- */
        .content-page { padding: 1rem 2rem; max-width: 56rem; margin: 0 auto; }
        .content-page h2 { font-size: 2rem; font-weight: bold; text-align: center; margin-bottom: 1.5rem; }
        .back-btn-container { text-align: center; margin-top: 2rem; }
        .back-btn { padding: 0.75rem 1.5rem; background-color: var(--gray-600); color: var(--white); border: none; border-radius: 0.5rem; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); cursor: pointer; }
        .back-btn:hover { background-color: var(--gray-700); }
        .prose { background-color: var(--white); padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); line-height: 1.7; }
        .prose h4 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .prose p, .prose li { color: #374151; }
        .prose ol, .prose ul { padding-left: 1.5rem; }
        .prose .disclaimer { font-weight: bold; color: var(--red-600); }

        /* --- 其他页面样式 --- */
        .setup-page { padding: 1rem 2rem; }
        .setup-page h2 { font-size: 2rem; font-weight: bold; text-align: center; margin-bottom: 1.5rem; }
        .level-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; max-width: 64rem; margin: 0 auto; }
        @media (min-width: 640px) { .level-grid { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 768px) { .level-grid { grid-template-columns: repeat(5, 1fr); } }
        @media (min-width: 1024px) { .level-grid { grid-template-columns: repeat(7, 1fr); } }
        .level-btn { padding: 1rem; background-color: var(--white); border: 2px solid var(--gray-300); border-radius: 0.5rem; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s; }
        .level-btn:hover { background-color: var(--gray-100); }
        .level-btn .decimal { display: block; font-size: 1.125rem; font-weight: bold; color: #1f2937; }
        .level-btn .logmar { display: block; font-size: 0.875rem; color: var(--gray-500); }
        #page-test { background-color: var(--gray-100); }
        .test-header, .test-footer { padding: 1rem; background-color: var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .test-footer { box-shadow: 0 -2px 4px rgba(0,0,0,0.1); justify-content: center; gap: 0.5rem; }
        @media (min-width: 768px) { .test-footer { gap: 1rem; } }
        .test-title { font-size: 1.25rem; font-weight: bold; }
        .test-info { display: flex; gap: 1rem; font-size: 1.125rem; }
        .test-info span { font-weight: 600; }
        .test-main { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        #e-chart-container { display: flex; align-items: center; justify-content: center; }
        #e-chart-svg { color: var(--black); }
        .touch-controls { padding: 1rem; background-color: var(--gray-200); }
        .touch-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; max-width: 20rem; margin: 0 auto; }
        .touch-btn { background-color: var(--white); border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1rem; display: flex; justify-content: center; align-items: center; border: none; cursor: pointer; }
        @media (min-width: 768px) { .touch-controls { display: none; } }
        .footer-btn { padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; color: var(--white); cursor: pointer; display: flex; align-items: center; font-weight: 500; }
        .footer-btn svg { margin-right: 0.5rem; width: 20px; height: 20px; }
        .btn-pause { background-color: var(--yellow-500); } .btn-pause:hover { background-color: var(--yellow-600); }
        .btn-resume { background-color: var(--green-500); } .btn-resume:hover { background-color: var(--green-600); }
        .btn-retry { background-color: var(--blue-500); } .btn-retry:hover { background-color: var(--blue-600); }
        .btn-end { background-color: var(--red-500); } .btn-end:hover { background-color: var(--red-600); }
        .btn-back-home { background-color: var(--gray-600); } .btn-back-home:hover { background-color: var(--gray-700); }
        #pause-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10; }
        #pause-overlay h2 { font-size: 3rem; font-weight: bold; color: var(--white); }
        #result-modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        .modal-content { background-color: var(--white); border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); padding: 2rem; max-width: 28rem; width: 100%; text-align: center; }
        .modal-content h2 { font-size: 2rem; font-weight: bold; margin-bottom: 1rem; }
        .modal-content p { font-size: 1.125rem; margin-bottom: 0.5rem; }
        .modal-actions { display: flex; flex-direction: column; gap: 1rem; margin-top: 2rem; }
        @media (min-width: 768px) { .modal-actions { flex-direction: row; justify-content: center; } }
        .modal-actions .btn { padding: 0.75rem 1.5rem; font-size: 1rem; }
        .history-table-container { overflow-x: auto; background-color: var(--white); border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); margin-top: 1.5rem; }
        .history-table { width: 100%; text-align: left; color: var(--gray-500); font-size: 0.875rem; border-collapse: collapse; }
        .history-table thead { background-color: var(--gray-50); color: #374151; text-transform: uppercase; font-size: 0.75rem; }
        .history-table th, .history-table td { padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--gray-200); }
        .history-table tbody tr:last-child td { border-bottom: none; }
        .no-history { text-align: center; color: var(--gray-500); margin-top: 3rem; }
        .history-actions { display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; }
        .history-actions .btn { padding: 0.75rem 1.5rem; font-size: 1rem; }
    </style>
</head>
<body>

    <!-- 新增：全局返回按钮 -->
    <a href="https://maggiec87.github.io/vision-kits/" class="global-back-button">返回</a>

    <!-- SVG 图标定义 -->
    <svg width="0" height="0" style="position:absolute">
        <defs>
            <symbol id="icon-eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></symbol>
            <symbol id="icon-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></symbol>
            <symbol id="icon-help" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></symbol>
            <symbol id="icon-play" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="6 3 20 12 6 21 6 3"/></symbol>
            <symbol id="icon-pause" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="14" y="4" width="4" height="16" rx="1"/><rect x="6" y="4" width="4" height="16" rx="1"/></symbol>
            <symbol id="icon-redo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/></symbol>
            <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></symbol>
            <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></symbol>
            <symbol id="icon-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></symbol>
            <symbol id="icon-down" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></symbol>
            <symbol id="icon-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></symbol>
            <symbol id="icon-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></symbol>
            <symbol id="icon-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></symbol>
            <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></symbol>
        </defs>
    </svg>

    <!-- 主页 -->
    <div id="page-home" class="page active">
        <div class="main-content">
            <h1>视力表提升裸眼</h1>
            <div class="home-grid">
                <button id="btn-goto-instructions" class="btn btn-gray"><svg><use href="#icon-help"/></svg>使用说明</button>
                <button id="btn-goto-baseline" class="btn btn-blue"><svg><use href="#icon-eye"/></svg>测定基准</button>
                <button id="btn-goto-fogging" class="btn btn-green"><svg><use href="#icon-chart"/></svg>雾视挑战</button>
                <button id="btn-goto-history" class="btn btn-purple"><svg><use href="#icon-chart"/></svg>历史记录</button>
            </div>
        </div>
    </div>

    <!-- 视标选择页 -->
    <div id="page-setup" class="page setup-page">
        <h2 id="setup-title"></h2>
        <div id="level-grid-container" class="level-grid"></div>
        <div class="back-btn-container">
            <button class="back-btn btn-nav-home">退出</button>
        </div>
    </div>

    <!-- 测试页 -->
    <div id="page-test" class="page">
        <header class="test-header">
            <div id="test-title" class="test-title"></div>
            <div class="test-info">
                <div><span>计时:</span> <span id="test-timer">0</span>s</div>
                <div><span>得分:</span> <span id="test-score">0/0</span></div>
            </div>
        </header>
        <main class="test-main">
            <div id="pause-overlay" style="display: none;"><h2>已暂停</h2></div>
            <div id="e-chart-container">
                <svg id="e-chart-svg" viewBox="0 0 5 5">
                    <path d="M0,0 H5 V1 H1 V2 H5 V3 H1 V4 H5 V5 H0 Z" fill="currentColor"/>
                </svg>
            </div>
        </main>
        <div class="touch-controls">
            <div class="touch-grid">
                <div></div><button class="touch-btn" data-dir="up"><svg><use href="#icon-up"/></svg></button><div></div>
                <button class="touch-btn" data-dir="left"><svg><use href="#icon-left"/></svg></button><div></div><button class="touch-btn" data-dir="right"><svg><use href="#icon-right"/></svg></button>
                <div></div><button class="touch-btn" data-dir="down"><svg><use href="#icon-down"/></svg></button><div></div>
            </div>
        </div>
        <footer class="test-footer">
            <button id="btn-pause-resume" class="footer-btn btn-pause"><svg><use href="#icon-pause"/></svg>暂停</button>
            <button id="btn-retry" class="footer-btn btn-retry"><svg><use href="#icon-redo"/></svg>重测</button>
            <button id="btn-end" class="footer-btn btn-end"><svg><use href="#icon-x"/></svg>结束</button>
            <button class="footer-btn btn-back-home btn-nav-home"><svg><use href="#icon-home"/></svg>返回</button>
        </footer>
    </div>

    <!-- 结果弹窗 -->
    <div id="result-modal" style="display: none;">
        <div class="modal-content">
            <h2 id="result-title">挑战结束</h2>
            <div id="result-body"></div>
            <div id="result-actions" class="modal-actions"></div>
        </div>
    </div>

    <!-- 历史记录页 -->
    <div id="page-history" class="page content-page">
        <!-- 内容由JS动态生成 -->
    </div>

    <!-- 使用说明页 -->
    <div id="page-instructions" class="page content-page">
        <div>
            <h2>6米雾视法|提升裸眼视力 <span style="font-size: 0.8em; color: var(--gray-500);">(by 欧老师)</span></h2>
            <div class="prose">
                <h4>训练原理</h4>
                <p>通过调整视标交替刺激睫状肌。</p>
                
                <h4>跟练指南</h4>
                <ol>
                    <li><strong>基准定位：</strong>站在距视力表 <strong>5米</strong> 处，找到自己能完全看清的那行视标。</li>
                    <li><strong>雾视挑战：：</strong>选择上一步测得的基准视标，后退至 <strong>6米</strong> 位置，循环交替指认基准视标和最大三行的视标。(每日早晚各 <strong>10分钟</strong>)</li>
                </ol>
                <p class="disclaimer">！！！注意：</p>
                <ul>
                    <li>双眼视力差 &gt;2行者，请遮盖弱势眼训练。</li>
                    <li>当能轻松看清当前目标行，立即下移一行加大难度，始终保持轻微模糊感。</li>
                </ul>

                <h4>双眼视差训练周期</h4>
                <ul>
                    <li><strong>DAY1-3：</strong>遮盖优势眼 <strong>20分钟/天</strong></li>
                    <li><strong>DAY4：</strong>遮盖弱势眼 <strong>30分钟/天</strong></li>
                    <li><strong>DAY5-7：</strong>循环DAY1-3模式</li>
                </ul>

                <h4>安全须知</h4>
                <ol>
                    <li>出现头晕/眼胀立即暂停。</li>
                    <li><strong>散光200度以上</strong> 必须戴镜。</li>
                    <li>训练后热敷眼周 <strong>3分钟</strong>。</li>
                    <li>配合 <strong>20-20-20护眼法则</strong>。</li>
                </ol>

                <h4>温馨Tips</h4>
                <ul>
                    <li><strong>最佳时段：</strong>晨起 & 放学后</li>
                    <li><strong>进阶版：</strong>加入动态追视卡</li>
                    <li><strong>饮食配合：</strong>补充叶黄素</li>
                    <li><strong>训练后：</strong>做晶体操或看3D动画放松</li>
                </ul>

                <h4>安全中止信号 <span style="font-weight:bold; color:var(--red-600);">(家长必读!)</span></h4>
                <ol>
                    <li>频繁揉眼/眨眼，立即暂停。</li>
                    <li>说 "眼睛好酸"，改做晶体操。</li>
                    <li>注意力涣散，切换动态追视卡。</li>
                    <li>头晕/恶心，冷敷眼周+远眺，立即暂停。</li>
                </ol>

                <h4>效果观测</h4>
                <p>坚持 <strong>15天</strong> 左右对比，观察裸眼视力表识别能力的变化。</p>
            </div>
            <div class="back-btn-container">
                <button class="back-btn btn-nav-home">退出</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 数据和常量 ---
    // 假设屏幕为 96 DPI，计算 1mm 对应的像素值
    const PIXELS_PER_MM_ASSUMED = 96 / 25.4;

    // 原始视力数据，并预先计算好固定像素尺寸
    const VISION_LEVELS = [
      { logMAR: '4.0', decimal: 0.1, sizeMm: 72.72 }, { logMAR: '4.1', decimal: 0.12, sizeMm: 60.60 },
      { logMAR: '4.2', decimal: 0.15, sizeMm: 48.48 }, { logMAR: '4.3', decimal: 0.2, sizeMm: 36.36 },
      { logMAR: '4.4', decimal: 0.25, sizeMm: 29.09 }, { logMAR: '4.5', decimal: 0.3, sizeMm: 24.24 },
      { logMAR: '4.6', decimal: 0.4, sizeMm: 18.18 }, { logMAR: '4.7', decimal: 0.5, sizeMm: 14.54 },
      { logMAR: '4.8', decimal: 0.6, sizeMm: 12.12 }, { logMAR: '4.9', decimal: 0.8, sizeMm: 9.09 },
      { logMAR: '5.0', decimal: 1.0, sizeMm: 7.27 }, { logMAR: '5.1', decimal: 1.2, sizeMm: 6.06 },
      { logMAR: '5.2', decimal: 1.5, sizeMm: 4.85 }, { logMAR: '5.3', decimal: 2.0, sizeMm: 3.64 },
    ].map(level => ({
        ...level,
        sizePx: level.sizeMm * PIXELS_PER_MM_ASSUMED
    }));

    const DIRECTIONS = ['up', 'down', 'left', 'right'];
    const KEY_MAP = { ArrowUp: 'up', ArrowDown: 'down', ArrowLeft: 'left', ArrowRight: 'right' };
    const ROTATION_MAP = { up: -90, down: 90, left: 180, right: 0 };

    // --- 应用状态 ---
    let appState = {
        currentPage: 'home',
        history: [],
        testConfig: null,
        testState: {
            status: 'idle',
            timer: 0,
            correct: 0,
            total: 0,
            currentE: null,
            type: null,
        },
        timerInterval: null,
    };

    // --- DOM 元素引用 ---
    const pages = document.querySelectorAll('.page');
    const eChartEl = document.getElementById('e-chart-svg');
    const testTimerEl = document.getElementById('test-timer');
    const testScoreEl = document.getElementById('test-score');
    const pauseOverlay = document.getElementById('pause-overlay');
    const btnPauseResume = document.getElementById('btn-pause-resume');
    const resultModal = document.getElementById('result-modal');

    // --- 核心功能函数 ---

    function navigateTo(pageId) {
        appState.currentPage = pageId;
        pages.forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${pageId}`).classList.add('active');
        if (pageId === 'history') renderHistoryPage();
    }

    function renderEChart(sizePx, direction) {
        eChartEl.style.width = `${sizePx}px`;
        eChartEl.style.height = `${sizePx}px`;
        eChartEl.style.transform = `rotate(${ROTATION_MAP[direction]}deg)`;
    }

    function generateRandomE(level) {
        const randomDirection = DIRECTIONS[Math.floor(Math.random() * DIRECTIONS.length)];
        return { level, direction: randomDirection };
    }

    function startTest(type, config) {
        appState.testConfig = config;
        let initialE;
        if (type === 'baseline') {
            initialE = generateRandomE(config.level);
        } else {
            const levels = [...config.fogLevels, config.minLevel];
            const randomLevel = levels[Math.floor(Math.random() * levels.length)];
            initialE = generateRandomE(randomLevel);
        }
        appState.testState = { status: 'running', timer: type === 'baseline' ? 30 : 60, correct: 0, total: 0, currentE: initialE, type: type };
        updateTestUI();
        navigateTo('test');
        startTimer();
    }
    
    function startTimer() {
        if (appState.timerInterval) clearInterval(appState.timerInterval);
        appState.timerInterval = setInterval(() => {
            appState.testState.timer--;
            testTimerEl.textContent = appState.testState.timer;
            if (appState.testState.timer <= 0) {
                endTest(true);
            }
        }, 1000);
    }

    function handleAnswer(answer) {
        if (appState.testState.status !== 'running') return;
        const state = appState.testState;
        const config = appState.testConfig;
        state.correct += (answer === state.currentE.direction ? 1 : 0);
        state.total += 1;
        let nextE;
        if (state.type === 'baseline') {
            nextE = generateRandomE(config.level);
        } else {
            const isNextMinLevel = (state.total + 1) % 2 !== 0; // 交替出现最小视标和雾视视标
            const levelToUse = isNextMinLevel ? config.minLevel : config.fogLevels[Math.floor(Math.random() * config.fogLevels.length)];
            nextE = generateRandomE(levelToUse);
        }
        state.currentE = nextE;
        updateTestUI();
    }

    function endTest(isFinished) {
        clearInterval(appState.timerInterval);
        appState.timerInterval = null;
        const state = appState.testState;
        if (isFinished) {
            state.status = 'finished';
            if (state.total > 0 || state.type === 'baseline') {
                const newRecord = { date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), type: state.type === 'baseline' ? '测定基准' : '雾视挑战', level: appState.testConfig?.level?.decimal || appState.testConfig?.minLevel?.decimal, accuracy: state.total > 0 ? (state.correct / state.total) * 100 : 0, score: `${state.correct}/${state.total}` };
                appState.history.unshift(newRecord); // 新记录放在最前面
                localStorage.setItem('visionHistory', JSON.stringify(appState.history));
            }
            showResultModal();
        } else {
            state.status = 'idle';
            navigateTo('home');
        }
    }
    
    function pauseTest() {
        if (appState.testState.status !== 'running') return;
        appState.testState.status = 'paused';
        clearInterval(appState.timerInterval);
        updateTestUI();
    }

    function resumeTest() {
        if (appState.testState.status !== 'paused') return;
        appState.testState.status = 'running';
        startTimer();
        updateTestUI();
    }
    
    function retryTest() {
        resultModal.style.display = 'none';
        startTest(appState.testState.type, appState.testConfig);
    }

    function updateTestUI() {
        const { status, timer, correct, total, currentE, type } = appState.testState;
        const config = appState.testConfig;
        document.getElementById('test-title').textContent = `${type === 'baseline' ? '基准测定' : '雾视挑战'} - ${config?.level?.decimal || config?.minLevel?.decimal}`;
        testTimerEl.textContent = timer;
        testScoreEl.textContent = `${correct}/${total}`;
        if (currentE) renderEChart(currentE.level.sizePx, currentE.direction);
        pauseOverlay.style.display = status === 'paused' ? 'flex' : 'none';
        btnPauseResume.innerHTML = status === 'running' ? '<svg><use href="#icon-pause"/></svg>暂停' : '<svg><use href="#icon-play"/></svg>继续';
        btnPauseResume.className = `footer-btn ${status === 'running' ? 'btn-pause' : 'btn-resume'}`;
        btnPauseResume.onclick = status === 'running' ? pauseTest : resumeTest;
    }

    function showResultModal() {
        resultModal.style.display = 'flex';
        const { type, correct, total } = appState.testState;
        const config = appState.testConfig;
        const level = type === 'baseline' ? config.level.decimal : config.minLevel.decimal;
        const accuracy = total > 0 ? ((correct / total) * 100).toFixed(0) : 0;
        
        document.getElementById('result-title').textContent = type === 'baseline' ? '基准测定完成' : '雾视挑战结束';
        document.getElementById('result-body').innerHTML = `
            <p>测试等级: <strong>${level}</strong></p>
            <p>最终得分: <strong>${correct} / ${total}</strong></p>
            <p>正确率: <strong>${accuracy}%</strong></p>
        `;
        document.getElementById('result-actions').innerHTML = `
            <button class="btn btn-blue" id="modal-btn-retry">再试一次</button>
            <button class="btn btn-gray" id="modal-btn-home">退出</button>
        `;
        document.getElementById('modal-btn-retry').onclick = retryTest;
        document.getElementById('modal-btn-home').onclick = () => {
            resultModal.style.display = 'none';
            navigateTo('home');
        };
    }

    // 新增：清空历史记录功能
    function clearHistory() {
        if (confirm('确定要清空所有历史记录吗？此操作不可撤销。')) {
            appState.history = [];
            localStorage.removeItem('visionHistory');
            renderHistoryPage(); // 重新渲染历史记录页面以显示空状态
        }
    }

    // 新增：导出历史记录功能 (CSV 格式)
    function exportHistory() {
        if (appState.history.length === 0) {
            alert('没有历史记录可以导出。');
            return;
        }

        const headers = ['日期', '时间', '类型', '等级', '得分', '正确率'];
        const csvRows = [];

        // 添加 CSV 头部
        csvRows.push(headers.map(h => `"${h}"`).join(','));

        // 添加数据行
        appState.history.forEach(record => {
            const values = [
                record.date,
                record.time,
                record.type,
                record.level,
                record.score,
                `${record.accuracy.toFixed(0)}%` // 格式化正确率
            ];
            // 处理 CSV 中的逗号和引号，确保数据正确性
            csvRows.push(values.map(v => `"${String(v).replace(/"/g, '""')}"`).join(','));
        });

        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `视力训练历史_${new Date().toISOString().slice(0, 10)}.csv`; // 文件名包含日期
        document.body.appendChild(link); // 兼容 Firefox
        link.click();
        document.body.removeChild(link); // 清理
        URL.revokeObjectURL(link.href); // 释放内存
    }


    function renderHistoryPage() {
        const container = document.getElementById('page-history');
        let contentHtml = '<h2>历史记录</h2>';

        if (appState.history.length === 0) {
            contentHtml += `<p class="no-history">暂无历史记录。</p>`;
        } else {
            const tableRows = appState.history.map(r => `
                <tr>
                    <td>${r.date} ${r.time}</td>
                    <td>${r.type}</td>
                    <td>${r.level}</td>
                    <td>${r.score} (${r.accuracy.toFixed(0)}%)</td>
                </tr>
            `).join('');
            contentHtml += `
                <div class="history-table-container">
                    <table class="history-table">
                        <thead><tr><th>时间</th><th>类型</th><th>等级</th><th>得分 (正确率)</th></tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>
                <div class="history-actions">
                    <button id="btn-export-history" class="btn btn-blue"><svg><use href="#icon-download"/></svg>导出</button>
                    <button id="btn-clear-history" class="btn btn-red"><svg><use href="#icon-trash"/></svg>清空</button>
                </div>
            `;
        }
        contentHtml += `<div class="back-btn-container"><button class="back-btn btn-nav-home">退出</button></div>`;
        container.innerHTML = contentHtml;

        // 重新绑定事件监听器，因为innerHTML会替换元素
        if (appState.history.length > 0) {
            document.getElementById('btn-export-history').onclick = exportHistory;
            document.getElementById('btn-clear-history').onclick = clearHistory;
        }
        container.querySelector('.btn-nav-home').onclick = () => navigateTo('home');
    }

    function setupLevelSelection(type) {
        document.getElementById('setup-title').textContent = type === 'baseline' ? '选择基准视标' : '选择最小视标';
        const gridContainer = document.getElementById('level-grid-container');
        gridContainer.innerHTML = '';
        VISION_LEVELS.forEach(level => {
            const btn = document.createElement('button');
            btn.className = 'level-btn';
            btn.innerHTML = `<span class="decimal">${level.decimal}</span><span class="logmar">(${level.logMAR})</span>`;
            btn.onclick = () => {
                if (type === 'baseline') {
                    startTest('baseline', { level });
                } else {
                    // 雾视挑战的雾视等级选择前3个（0.1, 0.12, 0.15）
                    startTest('fogging', { minLevel: level, fogLevels: VISION_LEVELS.slice(0, 3) });
                }
            };
            gridContainer.appendChild(btn);
        });
        navigateTo('setup');
    }

    // --- 事件监听器 ---
    
    document.getElementById('btn-goto-baseline').onclick = () => setupLevelSelection('baseline');
    document.getElementById('btn-goto-fogging').onclick = () => setupLevelSelection('fogging');
    document.getElementById('btn-goto-history').onclick = () => navigateTo('history');
    document.getElementById('btn-goto-instructions').onclick = () => navigateTo('instructions');
    document.querySelectorAll('.btn-nav-home').forEach(btn => btn.onclick = () => navigateTo('home'));
    
    btnPauseResume.onclick = pauseTest;
    document.getElementById('btn-retry').onclick = retryTest;
    document.getElementById('btn-end').onclick = () => endTest(true);
    document.querySelectorAll('.touch-btn').forEach(btn => {
        btn.onclick = () => handleAnswer(btn.dataset.dir);
    });

    window.addEventListener('keydown', (e) => {
        if (appState.currentPage === 'test' && appState.testState.status === 'running' && KEY_MAP[e.key]) {
            e.preventDefault();
            handleAnswer(KEY_MAP[e.key]);
        }
        // 按下 Esc 或 Backspace 键时，结束当前测试或退出
        if (e.key === 'Escape' || e.key === 'Backspace') {
            e.preventDefault();
            if (appState.currentPage === 'test') {
                endTest(true); // 结束测试并保存记录
            } else if (appState.currentPage !== 'home') {
                navigateTo('home');
            }
        }
    });

    // --- 初始化 ---
    function initialize() {
        const savedHistory = localStorage.getItem('visionHistory');
        if (savedHistory) {
            appState.history = JSON.parse(savedHistory);
        }
    }

    initialize();
});
</script>

</body>
</html>