<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>视力表提升裸眼</title>
    <style>
        /* --- 全局样式变量 --- */
        :root {
            --blue-500: #3b82f6; --blue-600: #2563eb;
            --green-500: #22c55e; --green-600: #16a34a;
            --purple-500: #a855f7; --purple-600: #9333ea;
            --gray-500: #6b7280; --gray-600: #4b5563; --gray-700: #374151;
            --yellow-500: #eab308; --yellow-600: #ca8a04;
            --red-500: #ef4444; --red-600: #dc2626;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-300: #d1d5db;
            --white: #ffffff; --black: #000000;
        }

        /* --- 基础样式 (Mobile-First) --- */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--gray-50);
            color: #333;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- 全局返回按钮样式 --- */
        .global-back-button {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
            padding: 0.5rem 1rem;
            background-color: var(--gray-600);
            color: var(--white);
            text-decoration: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* --- 页面容器 --- */
        .page {
            display: none;
            min-height: 100vh;
            width: 100%;
            box-sizing: border-box;
        }
        .page.active {
            display: flex;
            flex-direction: column;
        }
        
        /* --- 主页样式 --- */
        #page-home {
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        #page-home h1 {
            font-size: 2rem;
            font-weight: bold;
            color: var(--gray-700);
            margin-bottom: 2rem;
            text-align: center;
        }
        .home-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            width: 100%;
            max-width: 48rem;
        }

        /* --- 按钮通用样式 --- */
        .btn, .mobile-control-btn {
            color: var(--white);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: none;
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            text-decoration: none;
            box-sizing: border-box;
        }
        .btn:active, .mobile-control-btn:active {
            transform: scale(0.97);
            filter: brightness(0.95);
        }

        /* --- 按钮颜色工具类 --- */
        .bg-blue { background-color: var(--blue-500); }
        .bg-green { background-color: var(--green-500); }
        .bg-purple { background-color: var(--purple-500); }
        .bg-gray { background-color: var(--gray-500); }
        .bg-red { background-color: var(--red-500); }
        .bg-yellow { background-color: var(--yellow-500); }

        /* --- 主页按钮特定样式 --- */
        .btn { padding: 1.25rem; font-size: 1.125rem; width: 100%; }
        .btn svg { margin-right: 0.5rem; width: 20px; height: 20px; }

        /* --- 内容页 & Prose样式 --- */
        .content-page { padding: 1rem; max-width: 56rem; margin: 0 auto; }
        .content-page h2 { font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 0.5rem; }
        .content-page h4 { font-size: 1.1rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--gray-700); }
        .back-btn-container { text-align: center; margin-top: 1.5rem; }
        .back-btn { padding: 0.75rem 1.25rem; background-color: var(--gray-600); color: var(--white); border: none; border-radius: 0.5rem; cursor: pointer; }
        .prose { background-color: var(--white); padding: 1.25rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); line-height: 1.6; font-size: 0.95rem; }
        .prose p, .prose li { color: #374151; }
        .prose ol, .prose ul { padding-left: 1.25rem; margin-bottom: 1rem; }
        .prose .disclaimer { font-weight: bold; color: var(--red-600); margin-top: 1rem; }
        .author-info { text-align: center; color: var(--gray-500); font-size: 0.9rem; margin-bottom: 1.5rem; }
        .author-info a { color: var(--blue-500); text-decoration: none; }

        /* --- 视标选择页样式 --- */
        .setup-page { padding: 1rem; }
        .setup-page h2 { font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 1rem; }
        .level-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; max-width: 64rem; margin: 0 auto; }
        .level-btn { padding: 0.75rem; background-color: var(--white); border: 2px solid var(--gray-300); border-radius: 0.5rem; cursor: pointer; }
        .level-btn .decimal { display: block; font-size: 1rem; font-weight: bold; color: #1f2937; }
        .level-btn .logmar { display: block; font-size: 0.8rem; color: var(--gray-500); }

        /* --- 测试页样式 --- */
        #page-test { background-color: var(--gray-100); }
        .test-header {
            padding: 0.75rem;
            background-color: var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .test-title { font-size: 1rem; font-weight: bold; text-align: center; }
        .test-info { display: flex; gap: 0.75rem; font-size: 0.875rem; }
        .test-main { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        #e-chart-container { display: flex; align-items: center; justify-content: center; }
        #e-chart-svg { color: var(--black); }
        
        /* --- 移动端专属控制面板 --- */
        .mobile-controls-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
            background-color: var(--gray-200);
            flex-shrink: 0;
            align-items: center;
        }

        .directional-pad-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 0.25rem;
            width: 180px;
            height: 180px;
        }
        .directional-pad-container .mobile-control-btn {
            background-color: var(--white);
            color: var(--gray-700);
            height: 100%;
            width: 100%;
            font-size: 0.75rem;
            flex-direction: column;
        }
        .directional-pad-container .mobile-control-btn svg { width: 28px; height: 28px; }
        .directional-pad-container .btn-dir-up    { grid-area: 1 / 2 / 2 / 3; }
        .directional-pad-container .btn-dir-left  { grid-area: 2 / 1 / 3 / 2; }
        .directional-pad-container .btn-dir-right { grid-area: 2 / 3 / 3 / 4; }
        .directional-pad-container .btn-dir-down  { grid-area: 3 / 2 / 4 / 3; }

        /* --- 结果/菜单弹窗样式 (恢复) --- */
        #result-modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        .modal-content { background-color: var(--white); border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); padding: 1.5rem; max-width: 28rem; width: 100%; text-align: center; }
        .modal-content h2 { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.75rem; }
        .modal-content p { font-size: 1rem; margin-bottom: 0.4rem; }
        .modal-actions { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1.5rem; }
        .modal-actions .btn { padding: 0.75rem 1rem; font-size: 0.95rem; }

        /* --- 历史记录页样式 --- */
        .history-table-container { overflow-x: auto; background-color: var(--white); border-radius: 0.5rem; margin-top: 1.5rem; }
        .history-table { width: 100%; text-align: left; color: var(--gray-500); font-size: 0.8rem; border-collapse: collapse; }
        .history-table thead { background-color: var(--gray-50); color: #374151; }
        .history-table th, .history-table td { padding: 0.6rem 0.4rem; border-bottom: 1px solid var(--gray-200); }
        .history-actions { display: flex; justify-content: center; gap: 0.75rem; margin-top: 1.5rem; }

        /* --- 桌面端适配 --- */
        @media (min-width: 769px) {
            #page-home h1 { font-size: 3rem; margin-bottom: 3rem; }
            .home-grid { grid-template-columns: 1fr 1fr; gap: 1.5rem; }
            .content-page { padding: 2rem; }
            .level-grid { grid-template-columns: repeat(7, 1fr); }
            
            .test-header { flex-direction: row; justify-content: space-between; padding: 1rem; }
            .mobile-controls-panel { display: none; }

            .modal-actions { flex-direction: row; justify-content: center; }
            .modal-actions .btn { width: auto; min-width: 100px; }
        }
    </style>
</head>
<body>

    <!-- 全局返回按钮 -->
    <a href="https://maggiec87.github.io/vision-kits/" class="global-back-button">HOME</a>

    <!-- SVG 图标定义 -->
    <svg width="0" height="0" style="position:absolute">
        <defs>
            <symbol id="icon-eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></symbol>
            <symbol id="icon-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></symbol>
            <symbol id="icon-help" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></symbol>
            <symbol id="icon-menu" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></symbol>
            <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M5 12h14M5 12l4-4m-4 4l4 4"/><circle cx="19" cy="12" r="1" fill="currentColor"/></symbol>         
            <symbol id="icon-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></symbol>
            <symbol id="icon-down" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></symbol>
            <symbol id="icon-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></symbol>
            <symbol id="icon-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></symbol>
            <symbol id="icon-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></symbol>
            <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></symbol>
        </defs>
    </svg>

    <!-- 主页 -->
    <div id="page-home" class="page active">
        <div class="main-content">
            <h1>视力表提升裸眼</h1>
            <div class="home-grid">
                <button id="btn-goto-instructions" class="btn bg-gray"><svg><use href="#icon-help"/></svg>使用说明</button>
                <button id="btn-goto-baseline" class="btn bg-blue"><svg><use href="#icon-eye"/></svg>测定基准 (10次)</button>
                <button id="btn-goto-fogging" class="btn bg-green"><svg><use href="#icon-chart"/></svg>雾视挑战 (计时)</button>
                <button id="btn-goto-history" class="btn bg-purple"><svg><use href="#icon-chart"/></svg>历史记录</button>
            </div>
        </div>
    </div>

    <!-- 视标选择页 -->
    <div id="page-setup" class="page setup-page">
        <h2 id="setup-title"></h2>
        <div id="level-grid-container" class="level-grid"></div>
        <div class="back-btn-container">
            <button class="back-btn btn-nav-home">返回</button>
        </div>
    </div>

    <!-- 测试页 -->
    <div id="page-test" class="page">
        <header class="test-header">
            <div id="test-title" class="test-title"></div>
            <div class="test-info">
                <!-- 基准测试不显示计时器 -->
                <div id="timer-display"><span>计时:</span> <span id="test-timer">0</span>s</div>
                <div><span>得分:</span> <span id="test-score">0/0</span></div>
            </div>
        </header>
        <main class="test-main">
            <div id="e-chart-container">
                <svg id="e-chart-svg" viewBox="0 0 5 5">
                    <path d="M0,0 H5 V1 H1 V2 H5 V3 H1 V4 H5 V5 H0 Z" fill="currentColor"/>
                </svg>
            </div>
        </main>
        
        <!-- === 移动端专属控制面板 === -->
        <div class="mobile-controls-panel">
            <div class="directional-pad-container">
                <button class="mobile-control-btn touch-btn btn-dir-up" data-dir="up"><svg><use href="#icon-up"/></svg></button>
                <button class="mobile-control-btn touch-btn btn-dir-left" data-dir="left"><svg><use href="#icon-left"/></svg></button>
                <div style="grid-area: 2 / 2 / 3 / 3;"></div>
                <button class="mobile-control-btn touch-btn btn-dir-right" data-dir="right"><svg><use href="#icon-right"/></svg></button>
                <button class="mobile-control-btn touch-btn btn-dir-down" data-dir="down"><svg><use href="#icon-down"/></svg></button>
            </div>
        </div>
    </div>

    <!-- 菜单/结果弹窗 (恢复) -->
    <div id="result-modal" style="display: none;">
        <div class="modal-content">
            <h2 id="modal-title">已暂停</h2>
            <div id="modal-body"></div>
            <div id="modal-actions" class="modal-actions">
                <button id="modal-btn-end" class="btn bg-red">结束 (保存)</button>
                <button id="modal-btn-continue" class="btn bg-blue">继续</button>
                <button id="modal-btn-exit" class="btn bg-gray">退出 (不保存)</button>
            </div>
        </div>
    </div>

    <!-- 历史记录页 -->
    <div id="page-history" class="page content-page">
        <!-- 内容由JS动态生成 -->
    </div>

    <!-- 使用说明页 (更新文案) -->
    <div id="page-instructions" class="page content-page">
        <div>
            <h2>6米雾视法 | 提升裸眼视力</h2>
            <div class="author-info">
                原创：视目佳 欧老师 
                (<a href="https://mp.weixin.qq.com/s/luT-_g7lBULiP8KDCFDauA" target="_blank">点击查看原文</a>)
            </div>
            <div class="prose">
                <p><strong>原理：</strong>通过交替看大小视标来刺激睫状肌。</p>

                <h4>步骤：</h4>
                <ol>
                    <li><strong>基准定位：</strong>站在距视力表 <strong>5米</strong> 处，找到自己能完全看清的那行视标。</li>
                    <li><strong>雾视挑战：</strong>选择上一步测得的基准视标，后退至 <strong>6米</strong> 位置，循环交替指认基准视标和最大三行的视标。(每日早晚各 <strong>10分钟</strong>)</li>
                </ol>
                
                <p><strong>控制提示：</strong>测试过程中，按键盘 <strong>空格键</strong> 或 遥控器 <strong>确定键</strong> 可暂停并查看当前结果。</p>

                <p class="disclaimer">！！！注意：</p>
                <ul>
                    <li>双眼视力差2行者，请遮盖弱势眼训练。</li>
                    <li>当能轻松看清当前目标行，立即下移一行加大难度，始终保持轻微模糊感。</li>
                </ul>

                <h4>双眼视差训练周期：</h4>
                <ul>
                    <li><strong>DAY1-3：</strong>遮盖优势眼20 分钟/天</li>
                    <li><strong>DAY4：</strong>遮盖弱势眼30 分钟/天</li>
                    <li><strong>DAY5-7：</strong>循环DAY1-3模式</li>
                </ul>

                <p class="disclaimer">！！！安全须知：</p>
                <ul>
                    <li>出现头晕/眼胀立即暂停</li>
                    <li>散光200度以上必须戴镜</li>
                    <li>训练后热敷眼周3分钟</li>
                    <li>配合20-20-20护眼法则</li>
                    <li>频繁揉眼/眨眼, 立即暂停</li>
                    <li>说"眼睛好酸", 改做晶体操</li>
                    <li>注意力涣散, 切换动态追视卡</li>
                    <li>头晕/恶心, 冷敷眼周+远眺，立即暂停</li>
                </ul>

                <h4>温馨Tips：</h4>
                <ul>
                    <li><strong>最佳时段：</strong>晨起 & 放学后</li>
                    <li><strong>进阶版：</strong>加入动态追视卡</li>
                    <li><strong>饮食配合：</strong>补充叶黄素</li>
                    <li><strong>训练后：</strong>做晶体操或看3D动画放松</li>
                </ul>

                <h4>效果观测：</h4>
                <p>坚持15天左右对比视力表提升行数</p>
            </div>
            <div class="back-btn-container">
                <button class="back-btn btn-nav-home">返回</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 数据和常量 ---
    const PIXELS_PER_MM_ASSUMED = 96 / 25.4;
    const VISION_LEVELS = [
      { logMAR: '4.0', decimal: 0.1, sizeMm: 72.72 }, { logMAR: '4.1', decimal: 0.12, sizeMm: 60.60 },
      { logMAR: '4.2', decimal: 0.15, sizeMm: 48.48 }, { logMAR: '4.3', decimal: 0.2, sizeMm: 36.36 },
      { logMAR: '4.4', decimal: 0.25, sizeMm: 29.09 }, { logMAR: '4.5', decimal: 0.3, sizeMm: 24.24 },
      { logMAR: '4.6', decimal: 0.4, sizeMm: 18.18 }, { logMAR: '4.7', decimal: 0.5, sizeMm: 14.54 },
      { logMAR: '4.8', decimal: 0.6, sizeMm: 12.12 }, { logMAR: '4.9', decimal: 0.8, sizeMm: 9.09 },
      { logMAR: '5.0', decimal: 1.0, sizeMm: 7.27 }, { logMAR: '5.1', decimal: 1.2, sizeMm: 6.06 },
      { logMAR: '5.2', decimal: 1.5, sizeMm: 4.85 }, { logMAR: '5.3', decimal: 2.0, sizeMm: 3.64 },
    ].map(level => ({
        ...level,
        sizePx: (level.sizeMm * PIXELS_PER_MM_ASSUMED) / 4
    }));
    const DIRECTIONS = ['up', 'down', 'left', 'right'];
    const KEY_MAP = { ArrowUp: 'up', ArrowDown: 'down', ArrowLeft: 'left', ArrowRight: 'right' };
    const ROTATION_MAP = { up: -90, down: 90, left: 180, right: 0 };

    // --- 应用状态 ---
    let appState = {
        currentPage: 'home',
        history: [],
        testConfig: null,
        testState: {
            status: 'idle', timer: 0, correct: 0, total: 0, currentE: null, type: null,
        },
        timerInterval: null,
    };

    // --- DOM 元素引用 ---
    const pages = document.querySelectorAll('.page');
    const eChartEl = document.getElementById('e-chart-svg');
    const testTimerEl = document.getElementById('test-timer');
    const testScoreEl = document.getElementById('test-score');
    const resultModal = document.getElementById('result-modal');
    const globalBackButton = document.querySelector('.global-back-button');
    const timerDisplay = document.getElementById('timer-display');
    
    // --- 核心功能函数 ---
    function navigateTo(pageId) {
        appState.currentPage = pageId;
        pages.forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${pageId}`).classList.add('active');
        
        if (pageId === 'home') {
            globalBackButton.style.display = 'block';
        } else {
            globalBackButton.style.display = 'none';
        }

        window.scrollTo(0, 0);
        if (pageId === 'history') renderHistoryPage();
    }

    function renderEChart(sizePx, direction) {
        eChartEl.style.width = `${sizePx}px`;
        eChartEl.style.height = `${sizePx}px`;
        eChartEl.style.transform = `rotate(${ROTATION_MAP[direction]}deg)`;
    }

    function generateRandomE(level) {
        const randomDirection = DIRECTIONS[Math.floor(Math.random() * DIRECTIONS.length)];
        return { level, direction: randomDirection };
    }

    function startTest(type, config) {
        appState.testConfig = config;
        let initialE;
        if (type === 'baseline') {
            initialE = generateRandomE(config.level);
            timerDisplay.style.display = 'none'; // 基准测试隐藏倒计时
        } else {
            const levels = [...config.fogLevels, config.minLevel];
            const randomLevel = levels[Math.floor(Math.random() * levels.length)];
            initialE = generateRandomE(randomLevel);
            timerDisplay.style.display = 'block';
        }
        
        // 基准测试不设时间，雾视挑战设60秒
        const initialTimer = type === 'baseline' ? 0 : 60;

        appState.testState = { status: 'running', timer: initialTimer, correct: 0, total: 0, currentE: initialE, type: type };
        updateTestUI();
        navigateTo('test');
        
        if (type === 'fogging') {
            startTimer();
        }
    }
    
    function startTimer() {
        if (appState.timerInterval) clearInterval(appState.timerInterval);
        appState.timerInterval = setInterval(() => {
            if (appState.testState.status !== 'running') return;
            appState.testState.timer--;
            testTimerEl.textContent = appState.testState.timer;
            if (appState.testState.timer <= 0) {
                // 计时结束，自动结束并保存
                endTestAndSave();
            }
        }, 1000);
    }

    function handleAnswer(answer) {
        if (appState.testState.status !== 'running') return;
        const state = appState.testState;
        const config = appState.testConfig;
        
        state.correct += (answer === state.currentE.direction ? 1 : 0);
        state.total += 1;

        // 基准测试：满10次自动结算
        if (state.type === 'baseline' && state.total >= 10) {
            updateTestUI(); // 更新最后一次分数
            evaluateBaselineResult();
            return;
        }

        let nextE;
        if (state.type === 'baseline') {
            nextE = generateRandomE(config.level);
        } else {
            const isNextMinLevel = (state.total + 1) % 2 !== 0;
            const levelToUse = isNextMinLevel ? config.minLevel : config.fogLevels[Math.floor(Math.random() * config.fogLevels.length)];
            nextE = generateRandomE(levelToUse);
        }
        state.currentE = nextE;
        updateTestUI();
    }

    // --- 基准测试评估逻辑 ---
    function evaluateBaselineResult() {
        endTestAndSave();
    }

    // --- 菜单/模态框逻辑 (恢复) ---
    function showMenu() {
        // 暂停计时器
        if (appState.timerInterval) clearInterval(appState.timerInterval);
        if (appState.testState.status === 'running') appState.testState.status = 'paused';

        resultModal.style.display = 'flex';
        document.getElementById('modal-title').textContent = "已暂停";
        
        const { correct, total, type } = appState.testState;
        const config = appState.testConfig;
        const level = type === 'baseline' ? config.level.decimal : config.minLevel.decimal;

        document.getElementById('modal-body').innerHTML = `
            <p>当前模式: ${type === 'baseline' ? '基准测试' : '雾视挑战'}</p>
            <p>当前视标: ${level}</p>
            <p>当前得分: <strong>${correct} / ${total}</strong></p>
        `;

        // 绑定按钮事件
        document.getElementById('modal-btn-continue').onclick = resumeTest;
        document.getElementById('modal-btn-end').onclick = () => endTestAndSave();
        document.getElementById('modal-btn-exit').onclick = () => {
             resultModal.style.display = 'none';
             appState.testState.status = 'idle';
             navigateTo('home'); // 退出不保存
        };
    }

    function resumeTest() {
        resultModal.style.display = 'none';
        appState.testState.status = 'running';
        if (appState.testState.type === 'fogging') {
            startTimer();
        }
    }

    function endTestAndSave() {
        resultModal.style.display = 'none';
        if (appState.timerInterval) clearInterval(appState.timerInterval);
        const state = appState.testState;
        
        // 只有有数据才保存
        if (state.total > 0 || state.type === 'baseline') { 
            const newRecord = { 
                date: new Date().toLocaleDateString(), 
                time: new Date().toLocaleTimeString(), 
                type: state.type === 'baseline' ? '测定基准' : '雾视挑战', 
                level: appState.testConfig?.level?.decimal || appState.testConfig?.minLevel?.decimal, 
                accuracy: state.total > 0 ? (state.correct / state.total) * 100 : 0, 
                score: `${state.correct}/${state.total}` 
            };
            appState.history.unshift(newRecord);
            try {
                localStorage.setItem('visionHistory', JSON.stringify(appState.history));
            } catch (e) { console.error(e); }
        }
        
        appState.testState.status = 'idle';
        navigateTo('history');
    }

    function updateTestUI() {
        const { timer, correct, total, currentE, type } = appState.testState;
        const config = appState.testConfig;
        document.getElementById('test-title').textContent = `${type === 'baseline' ? '基准测定' : '雾视挑战'} - ${config?.level?.decimal || config?.minLevel?.decimal}`;
        testTimerEl.textContent = timer;
        testScoreEl.textContent = `${correct}/${total}`;
        if (currentE) renderEChart(currentE.level.sizePx, currentE.direction);
    }

    function clearHistory() {
        if (confirm('确定要清空所有历史记录吗？')) {
            appState.history = [];
            localStorage.removeItem('visionHistory');
            renderHistoryPage();
        }
    }

    function exportHistory() {
        if (appState.history.length === 0) return alert('没有记录');
        const csvContent = "data:text/csv;charset=utf-8,\uFEFF" 
            + "日期,时间,类型,等级,得分,正确率\n" 
            + appState.history.map(e => `${e.date},${e.time},${e.type},${e.level},${e.score},${e.accuracy.toFixed(0)}%`).join("\n");
        const link = document.createElement("a");
        link.href = encodeURI(csvContent);
        link.download = "vision_history.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function renderHistoryPage() {
        const container = document.getElementById('page-history');
        let contentHtml = '<h2>历史记录</h2>';
        if (appState.history.length === 0) {
            contentHtml += `<p style="text-align:center;color:#666;margin-top:2rem;">暂无历史记录。</p>`;
        } else {
            const tableRows = appState.history.map(r => `<tr><td>${r.date}<br>${r.time}</td><td>${r.type}</td><td>${r.level}</td><td>${r.score}<br>(${r.accuracy.toFixed(0)}%)</td></tr>`).join('');
            contentHtml += `<div class="history-table-container"><table class="history-table"><thead><tr><th>时间</th><th>类型</th><th>等级</th><th>得分</th></tr></thead><tbody>${tableRows}</tbody></table></div><div class="history-actions"><button id="btn-export-history" class="btn bg-blue"><svg><use href="#icon-download"/></svg>导出</button><button id="btn-clear-history" class="btn bg-red"><svg><use href="#icon-trash"/></svg>清空</button></div>`;
        }
        contentHtml += `<div class="back-btn-container"><button class="back-btn btn-nav-home">返回</button></div>`;
        container.innerHTML = contentHtml;
        if (appState.history.length > 0) {
            document.getElementById('btn-export-history').onclick = exportHistory;
            document.getElementById('btn-clear-history').onclick = clearHistory;
        }
        container.querySelector('.btn-nav-home').onclick = () => navigateTo('home');
    }

    function setupLevelSelection(type) {
        document.getElementById('setup-title').textContent = type === 'baseline' ? '选择基准视标 (测10次)' : '选择最小视标';
        const gridContainer = document.getElementById('level-grid-container');
        gridContainer.innerHTML = '';
        VISION_LEVELS.forEach(level => {
            const btn = document.createElement('button');
            btn.className = 'level-btn';
            btn.innerHTML = `<span class="decimal">${level.decimal}</span><span class="logmar">(${level.logMAR})</span>`;
            btn.onclick = () => {
                if (type === 'baseline') {
                    startTest('baseline', { level });
                } else {
                    startTest('fogging', { minLevel: level, fogLevels: VISION_LEVELS.slice(0, 3) });
                }
            };
            gridContainer.appendChild(btn);
        });
        navigateTo('setup');
    }

    // --- 事件监听器 ---
    document.getElementById('btn-goto-baseline').onclick = () => setupLevelSelection('baseline');
    document.getElementById('btn-goto-fogging').onclick = () => setupLevelSelection('fogging');
    document.getElementById('btn-goto-history').onclick = () => navigateTo('history');
    document.getElementById('btn-goto-instructions').onclick = () => navigateTo('instructions');
    document.querySelectorAll('.btn-nav-home').forEach(btn => btn.onclick = () => navigateTo('home'));
    
    document.querySelectorAll('.touch-btn').forEach(btn => {
        btn.onclick = () => handleAnswer(btn.dataset.dir);
    });

    // 键盘/遥控器事件
    window.addEventListener('keydown', (e) => {
        const keyCode = e.keyCode || e.which;
        
        // 如果不在测试页，按返回键回主页
        if (appState.currentPage !== 'test') {
            if (e.key === 'Escape' || e.key === 'Backspace') {
                e.preventDefault();
                navigateTo('home');
            }
            return;
        }

        // 测试页逻辑
        // 1. 确定/OK/空格 -> 弹出菜单 (恢复此功能)
        if (e.key === 'Enter' || e.key === ' ' || keyCode === 13) {
            e.preventDefault();
            // 如果菜单已打开，按确定默认继续
            if (resultModal.style.display === 'flex') {
                resumeTest();
            } else {
                showMenu();
            }
            return;
        }

        // 2. 菜单已打开时，阻止方向键操作视标
        if (resultModal.style.display === 'flex') return;

        // 3. 方向键操作
        if (KEY_MAP[e.key]) {
            e.preventDefault();
            handleAnswer(KEY_MAP[e.key]);
        }
    });

    // --- 初始化 ---
    function initialize() {
        try {
            const savedHistory = localStorage.getItem('visionHistory');
            if (savedHistory) appState.history = JSON.parse(savedHistory);
        } catch (e) { console.error(e); }
        navigateTo('home');
    }

    initialize();
});
</script>

</body>
</html>
