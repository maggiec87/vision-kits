<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>检查记录</title>
    <!-- 仅引入 html2canvas 用于生成图片 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #00796b;
            --secondary-color: #4a5568;
            --background-color: #f4f5f7;
            --card-bg-color: #ffffff;
            --border-color: #e2e8f0;
            --input-bg-color: #f8f9fa;
            --success-color: #38a169;
            --danger-color: #e53e3e;
            --info-color: #3182ce;
            --warning-color: #f0ad4e;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--secondary-color);
            margin: 0;
            padding: 20px;
            -webkit-text-size-adjust: 100%;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--card-bg-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        h1, h2, h3, h4 {
            color: var(--primary-color);
            margin-top: 0;
        }
        h1, h2 { text-align: center; margin-bottom: 25px; }
        h3 { margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        h4 { margin-bottom: 10px; font-size: 1.1em; color: var(--secondary-color); }

        .header-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 15px; border: none; border-radius: 8px; font-size: 16px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            text-decoration: none; display: inline-block; text-align: center;
        }
        .btn-sm { padding: 5px 10px; font-size: 12px; border-radius: 6px; }
        .btn-primary { background-color: var(--primary-color); color: white; width: 100%; margin-top: 20px; }
        .btn-primary:hover { background-color: #005a4f; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-calc { background-color: var(--warning-color); color: white; }
        .btn-share { background-color: var(--info-color); color: white; }

        form { display: flex; flex-direction: column; gap: 30px; }
        fieldset {
            border: 1px solid var(--border-color); border-radius: 8px; padding: 25px;
            margin: 0;
        }
        legend {
            font-weight: 600; font-size: 1.3em; color: var(--primary-color);
            padding: 0 10px; margin-left: 10px;
        }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-weight: 500; font-size: 0.9em; }
        label small { font-weight: 400; color: #777; margin-left: 5px; font-size: 0.9em; }
        input, select, textarea {
            padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;
            font-size: 16px; background-color: var(--input-bg-color); width: 100%;
            box-sizing: border-box;
        }
        textarea { resize: vertical; min-height: 80px; }
        
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
        .grid-dynamic { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        
        .input-group { display: flex; align-items: center; gap: 5px; }
        .input-group input { flex-grow: 1; }
        .input-group .btn-sm { flex-shrink: 0; }
        
        .history-section { margin-top: 40px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        #export-btn { background-color: var(--success-color); color: white; }
        
        .history-table { width: 100%; border-collapse: collapse; text-align: left; }
        .history-table th, .history-table td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; word-wrap: break-word; }
        .history-table th { font-weight: 600; background-color: #f8f9fa; }
        .history-table .actions-cell { text-align: right; white-space: nowrap; }
        .history-table .actions-cell .btn { margin-left: 5px; padding: 5px 10px; font-size: 14px; }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fff; margin: auto; padding: 20px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 800px;
            position: relative; max-height: 85vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; font-size: 1.5em; }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; border: none; background: none; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .detail-group { background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .detail-group h4 { margin: 0 0 10px 0; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .detail-item { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.95em; flex-wrap: wrap; }
        .detail-item span:first-child { font-weight: 600; color: var(--secondary-color); margin-right: 10px; }
        .detail-item span:last-child { text-align: right; flex-grow: 1; word-break: break-all; }

        /* Report Card for PNG Export - Hidden by default */
        #report-card-wrapper {
            position: absolute;
            left: -9999px;
            top: -9999px;
            padding: 20px;
            background-color: #f0f0f0;
        }
        #report-card-template {
            width: 800px;
            padding: 30px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-family: sans-serif;
            color: #333;
        }
        .report-header { text-align: center; margin-bottom: 25px; }
        .report-header h2 { color: var(--primary-color); margin: 0; }
        .report-header p { margin: 5px 0 0; color: #666; }
        .report-section { margin-bottom: 20px; }
        .report-section h3 {
            font-size: 1.2em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 30px; }
        .report-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee; }
        .report-item-label { font-weight: bold; }
        .report-item-value { color: #555; }
        .report-footer { text-align: center; margin-top: 30px; font-size: 0.8em; color: #999; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px 15px; }
            .grid-2, .grid-3, .grid-4, .grid-dynamic { grid-template-columns: 1fr; }
            
            .compact-grid-3 { grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
            .compact-grid-2 { grid-template-columns: 1fr 1fr; gap: 10px; }

            .history-table { display: block; }
            .history-table thead { display: none; }
            .history-table tbody, .history-table tr, .history-table td { display: block; width: 100%; box-sizing: border-box; }
            .history-table tr {
                margin-bottom: 15px; border: 1px solid var(--border-color);
                border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 15px;
            }
            .history-table td {
                display: flex; justify-content: space-between; align-items: center;
                padding: 10px 5px; border: none; text-align: right;
                word-break: break-word;
            }
            .history-table td::before {
                content: attr(data-label); font-weight: 600; color: var(--primary-color);
                text-align: left; padding-right: 10px;
            }
            .history-table .actions-cell { justify-content: flex-end; padding-top: 15px; }
            .history-table .actions-cell::before { display: none; }
            .modal-content { width: 95%; max-height: 90vh; }
            .detail-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-nav">
            <h1>检查记录</h1>
            <div class="header-actions">
                <button id="share-png-btn" class="btn btn-share">分享数据</button>
                <a href="index.html" class="btn btn-secondary">返回</a>
            </div>
        </div>

        <form id="exam-form">
            <!-- 基本信息 -->
            <fieldset>
                <legend>基本信息</legend>
                <div class="grid grid-dynamic">
                    <div class="form-group"><label for="exam-date">检查日期</label><input type="date" id="exam-date"></div>
                    <div class="form-group"><label for="exam-institution">检查机构</label><input type="text" id="exam-institution" placeholder="例如: 深圳市眼科医院"></div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="notes">备注</label>
                    <textarea id="notes" placeholder="其他需要记录的信息"></textarea>
                </div>
            </fieldset>

            <!-- 验光数据 -->
            <fieldset>
                <legend>验光数据</legend>
                <div class="form-group">
                    <label>裸眼视力</label>
                    <div class="grid grid-2 compact-grid-2">
                       <input type="text" id="va-od" placeholder="OD (例如: 0.8 或 4.9)">
                       <input type="text" id="va-os" placeholder="OS (例如: 0.8 或 4.9)">
                    </div>
                </div>
                <h3 style="margin-top: 20px;">电脑验光</h3>
                <div class="grid grid-2">
                    <div class="form-group"><label>右眼 (OD)</label><div class="grid grid-3 compact-grid-3"><input type="number" step="0.25" id="ar-s-od" placeholder="SPH"><input type="number" step="0.25" id="ar-c-od" placeholder="CYL"><input type="number" step="1" id="ar-a-od" placeholder="AX"></div></div>
                    <div class="form-group"><label>左眼 (OS)</label><div class="grid grid-3 compact-grid-3"><input type="number" step="0.25" id="ar-s-os" placeholder="SPH"><input type="number" step="0.25" id="ar-c-os" placeholder="CYL"><input type="number" step="1" id="ar-a-os" placeholder="AX"></div></div>
                </div>
                <h3 style="margin-top: 30px;">综合验光</h3>
                <div class="grid grid-2">
                    <div class="form-group"><label>右眼 (OD)</label><div class="grid grid-3 compact-grid-3"><input type="number" step="0.25" id="sr-s-od" placeholder="SPH"><input type="number" step="0.25" id="sr-c-od" placeholder="CYL"><input type="number" step="1" id="sr-a-od" placeholder="AX"></div></div>
                    <div class="form-group"><label>左眼 (OS)</label><div class="grid grid-3 compact-grid-3"><input type="number" step="0.25" id="sr-s-os" placeholder="SPH"><input type="number" step="0.25" id="sr-c-os" placeholder="CYL"><input type="number" step="1" id="sr-a-os" placeholder="AX"></div></div>
                </div>
                <div class="form-group" style="margin-top: 20px;"><label>矫正视力</label><div class="grid grid-2 compact-grid-2"><input type="text" id="cva-od" placeholder="OD (例如: 1.0 或 5.0)"><input type="text" id="cva-os" placeholder="OS (例如: 1.0 或 5.0)"></div></div>
            </fieldset>

            <!-- 生物测量数据 -->
            <fieldset>
                <legend>生物测量数据</legend>
                <div class="form-group"><label for="bio-device">测量设备</label><select id="bio-device"><option value="">-- 请选择 --</option><option value="蔡司700">蔡司700</option><option value="蔡司500">蔡司500</option><option value="索维">索维(Suowei)</option><option value="尼德克">尼德克(Nidek)</option><option value="其他">其他</option></select></div>
                <div class="grid grid-dynamic" style="margin-top: 20px;">
                    <div class="form-group"><label>眼轴 (AL, mm)</label><div class="grid grid-2 compact-grid-2"><input type="number" step="0.01" id="al-od" placeholder="OD"><input type="number" step="0.01" id="al-os" placeholder="OS"></div></div>
                    <div class="form-group"><label>晶体厚度 (LT, mm)</label><div class="grid grid-2 compact-grid-2"><input type="number" step="0.01" id="lt-od" placeholder="OD"><input type="number" step="0.01" id="lt-os" placeholder="OS"></div></div>
                    <div class="form-group"><label>瞳孔直径 (P, mm)</label><div class="grid grid-2 compact-grid-2"><input type="number" step="0.1" id="p-od" placeholder="OD"><input type="number" step="0.1" id="p-os" placeholder="OS"></div></div>
                </div>
                <div class="grid grid-3" style="margin-top: 20px;">
                    <div class="form-group"><label>ACD (mm)</label><div class="grid grid-2 compact-grid-2"><input type="number" step="0.01" id="acd-od" placeholder="OD"><input type="number" step="0.01" id="acd-os" placeholder="OS"></div></div>
                    <div class="form-group"><label>角膜厚度 (CTT, μm)</label><div class="grid grid-2 compact-grid-2"><input type="number" id="ctt-od" placeholder="OD"><input type="number" id="ctt-os" placeholder="OS"></div></div>
                    <div class="form-group"><label>前房深度 (AD, mm)</label><div class="input-group"><div class="grid grid-2 compact-grid-2" style="flex-grow:1;"><input type="number" step="0.01" id="ad-od" placeholder="OD"><input type="number" step="0.01" id="ad-os" placeholder="OS"></div><button type="button" id="calc-ad-btn" class="btn btn-sm btn-calc">计算</button></div></div>
                </div>
                <div class="form-group" style="margin-top: 20px;"><label>曲率 (K, D)</label><div class="grid grid-4"><input type="number" step="0.01" id="k1-od" placeholder="OD K1"><input type="number" step="0.01" id="k2-od" placeholder="OD K2"><input type="number" step="0.01" id="k1-os" placeholder="OS K1"><input type="number" step="0.01" id="k2-os" placeholder="OS K2"></div></div>
            </fieldset>
            
            <!-- 视功能 -->
            <fieldset>
                <legend>视功能</legend>
                <h3>双眼视</h3>
                <div class="grid grid-dynamic"><div class="form-group"><label for="worth4">Worth4点</label><input type="text" id="worth4" placeholder="正常: 4点"></div><div class="form-group"><label for="stereo">立体视</label><input type="text" id="stereo" placeholder="正常: ≤60秒"></div></div>
                <h3 style="margin-top: 30px;">反应集合能力</h3>
                <div class="grid grid-dynamic">
                    <div class="form-group"><label>远眼位 隐斜位</label><input type="text" id="far-phoria" placeholder="例: 1△EP"></div>
                    <div class="form-group"><label>远融像(BO)<small>(B/B/R)</small></label><div class="grid grid-3 compact-grid-3"><input type="text" id="far-fus-bo-blur" placeholder="模糊"><input type="text" id="far-fus-bo-break" placeholder="破裂"><input type="text" id="far-fus-bo-rec" placeholder="恢复"></div></div>
                    <div class="form-group"><label>远融像(BI)<small>(B/B/R)</small></label><div class="grid grid-3 compact-grid-3"><input type="text" id="far-fus-bi-blur" placeholder="模糊"><input type="text" id="far-fus-bi-break" placeholder="破裂"><input type="text" id="far-fus-bi-rec" placeholder="恢复"></div></div>
                    <div class="form-group"><label>近眼位(40cm) 隐斜位</label><input type="text" id="near-phoria" placeholder="例: 3△EP"></div>
                    <div class="form-group"><label>AC/A比率</label><input type="text" id="ac-a-ratio" placeholder="正常: 4±2 △/D"></div>
                    <div class="form-group"><label>+1.00D 水平眼位</label><input type="text" id="plus1-phoria" placeholder="BI/BO/值 (△)"></div>
                    <div class="form-group"><label>近融像(BO)<small>(B/B/R)</small></label><div class="grid grid-3 compact-grid-3"><input type="text" id="near-fus-bo-blur" placeholder="模糊"><input type="text" id="near-fus-bo-break" placeholder="破裂"><input type="text" id="near-fus-bo-rec" placeholder="恢复"></div></div>
                    <div class="form-group"><label>近融像(BI)<small>(B/B/R)</small></label><div class="grid grid-3 compact-grid-3"><input type="text" id="near-fus-bi-blur" placeholder="模糊"><input type="text" id="near-fus-bi-break" placeholder="破裂"><input type="text" id="near-fus-bi-rec" placeholder="恢复"></div></div>
                </div>
                <h3 style="margin-top: 30px;">反应调节能力</h3>
                <div class="grid grid-dynamic">
                    <div class="form-group"><label>NRA</label><input type="number" step="0.25" id="nra" placeholder="正常: +2.00±0.50D"></div>
                    <div class="form-group"><label>PRA</label><input type="number" step="0.25" id="pra" placeholder="正常: -2.37±1.00D"></div>
                    <div class="form-group"><label>调节反应BCC</label><div class="grid grid-2 compact-grid-2"><input type="text" id="bcc-lead" placeholder="超前 -_D"><input type="text" id="bcc-lag" placeholder="滞后 (正常: +0.50~+0.75D)"></div></div>
                    <div class="form-group"><label>集合近点(NPC)</label><input type="text" id="npc" placeholder="正常: ≤5cm/7cm"></div>
                </div>
                <div class="grid grid-dynamic" style="margin-top: 20px;"><div class="form-group"><label>ADD(公式法)</label><div class="input-group"><input type="text" id="add-formula" placeholder="结果 (D)" readonly><button type="button" id="calc-add-btn" class="btn btn-sm btn-calc">计算</button></div></div><div class="form-group"><label>AMP(镜片法)</label><div class="input-group"><input type="text" id="amp-lens" placeholder="结果 (D)" readonly><button type="button" id="calc-amp-btn" class="btn btn-sm btn-calc">计算</button></div></div></div>
                <div class="form-group" style="margin-top: 20px;"><label>调节灵敏度(cpm)</label><div class="grid grid-3 compact-grid-3"><input type="number" id="flipper-od" placeholder="OD"><input type="number" id="flipper-os" placeholder="OS"><input type="number" id="flipper-ou" placeholder="OU"></div></div>
            </fieldset>

            <button type="submit" class="btn btn-primary">保存</button>
        </form>

        <!-- 历史 -->
        <div class="history-section">
            <div class="history-header"><h2>历史</h2><button id="export-btn" class="btn">导出记录</button></div>
            <table class="history-table"><thead><tr><th>日期</th><th>机构</th><th>眼轴(OD/OS)</th><th>综合验光(OD/OS)</th><th class="actions-cell">操作</th></tr></thead><tbody id="history-table-body"></tbody></table>
        </div>
    </div>

    <!-- 详情弹窗 -->
    <div id="details-modal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="modal-title">检查详情</h3><span class="close-btn">&times;</span></div><div id="modal-body"></div></div></div>
    
    <!-- Hidden Report Card for PNG generation -->
    <div id="report-card-wrapper">
        <div id="report-card-template">
            <div class="report-header">
                <h2 id="report-title">眼健康检查报告</h2>
                <p>日期: <span id="report-date"></span> | 机构: <span id="report-institution"></span></p>
            </div>
            <div class="report-section">
                <h3>核心屈光数据</h3>
                <div class="report-grid">
                    <div class="report-item"><span class="report-item-label">裸眼视力 (OD/OS)</span> <span class="report-item-value" id="report-va"></span></div>
                    <div class="report-item"><span class="report-item-label">矫正视力 (OD/OS)</span> <span class="report-item-value" id="report-cva"></span></div>
                    <div class="report-item"><span class="report-item-label">电脑验光 (OD)</span> <span class="report-item-value" id="report-ar-od"></span></div>
                    <div class="report-item"><span class="report-item-label">电脑验光 (OS)</span> <span class="report-item-value" id="report-ar-os"></span></div>
                    <div class="report-item"><span class="report-item-label">综合验光 (OD)</span> <span class="report-item-value" id="report-sr-od"></span></div>
                    <div class="report-item"><span class="report-item-label">综合验光 (OS)</span> <span class="report-item-value" id="report-sr-os"></span></div>
                </div>
            </div>
            <div class="report-section">
                <h3>关键生物学参数</h3>
                <div class="report-grid">
                    <div class="report-item"><span class="report-item-label">眼轴 (AL) OD/OS</span> <span class="report-item-value" id="report-al"></span></div>
                    <div class="report-item"><span class="report-item-label">角膜曲率 (K) OD</span> <span class="report-item-value" id="report-k-od"></span></div>
                    <div class="report-item"><span class="report-item-label">角膜曲率 (K) OS</span> <span class="report-item-value" id="report-k-os"></span></div>
                    <div class="report-item"><span class="report-item-label">前房深度 (AD) OD/OS</span> <span class="report-item-value" id="report-ad"></span></div>
                </div>
            </div>
            <div class="report-footer">
                <p>本报告数据仅供参考。</p>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element Selectors ---
        const form = document.getElementById('exam-form');
        const historyTableBody = document.getElementById('history-table-body');
        const exportBtn = document.getElementById('export-btn');
        const modal = document.getElementById('details-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.querySelector('.close-btn');
        const sharePngBtn = document.getElementById('share-png-btn');
        
        const calcAdBtn = document.getElementById('calc-ad-btn');
        const calcAddBtn = document.getElementById('calc-add-btn');
        const calcAmpBtn = document.getElementById('calc-amp-btn');

        const DB_KEY = 'eyeExamRecords_v5';
        let records = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        const formInputs = Array.from(form.querySelectorAll('input, textarea, select'));
        
        // --- Utility Functions ---
        const saveRecords = () => localStorage.setItem(DB_KEY, JSON.stringify(records));
        const getInputValue = (id) => document.getElementById(id).value;
        const setInputValue = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.value = value;
        };
        const formatRx = (s, c, a, placeholder = '-') => {
            if (!s && !c && !a) return placeholder;
            let s_val = parseFloat(s);
            let c_val = parseFloat(c);
            let rx = !isNaN(s_val) ? s_val.toFixed(2) : '0.00';
            if (!isNaN(c_val) && c_val !== 0) {
                rx += ` / ${c_val.toFixed(2)} x ${a || '0'}`;
            }
            return rx;
        };

        // --- Core Logic: History, Form, Modal ---
        const renderHistory = () => {
            historyTableBody.innerHTML = '';
            [...records].sort((a, b) => new Date(b['exam-date']) - new Date(a['exam-date'])).forEach(rec => {
                const tr = document.createElement('tr');
                const na = '无';
                const odRx = formatRx(rec['sr-s-od'], rec['sr-c-od'], rec['sr-a-od']);
                const osRx = formatRx(rec['sr-s-os'], rec['sr-c-os'], rec['sr-a-os']);
                tr.innerHTML = `
                    <td data-label="日期">${rec['exam-date'] || na}</td>
                    <td data-label="机构">${rec['exam-institution'] || na}</td>
                    <td data-label="眼轴">${rec['al-od'] || '-'}/${rec['al-os'] || '-'}</td>
                    <td data-label="综合验光">${odRx} / ${osRx}</td>
                    <td class="actions-cell">
                        <button class="btn btn-info details-btn" data-id="${rec.id}">详情</button>
                        <button class="btn btn-danger delete-btn" data-id="${rec.id}">删除</button>
                    </td>
                `;
                historyTableBody.appendChild(tr);
            });
        };

        const handleFormSubmit = (e) => {
            e.preventDefault();
            const newRecord = { id: Date.now() };
            formInputs.forEach(input => { if (input.id) newRecord[input.id] = input.value; });
            records.push(newRecord);
            saveRecords();
            renderHistory();
            form.reset();
            setInputValue('exam-date', new Date().toISOString().split('T')[0]);
            alert('检查记录已保存！');
        };
        
        const showDetailsModal = (recordId) => {
            const record = records.find(r => r.id == recordId);
            if (!record) return;
            const na = 'N/A';
            const val = (key) => record[key] || na;
            
            const odArRx = formatRx(val('ar-s-od'), val('ar-c-od'), val('ar-a-od'));
            const osArRx = formatRx(val('ar-s-os'), val('ar-c-os'), val('ar-a-os'));
            const odSrRx = formatRx(val('sr-s-od'), val('sr-c-od'), val('sr-a-od'));
            const osSrRx = formatRx(val('sr-s-os'), val('sr-c-os'), val('sr-a-os'));

            modalTitle.textContent = `检查详情 - ${val('exam-date')}`;
            modalBody.innerHTML = `
                <div class="detail-grid">
                    <div class="detail-group"><h4>基本信息</h4><div class="detail-item"><span>检查日期:</span> <span>${val('exam-date')}</span></div><div class="detail-item"><span>检查机构:</span> <span>${val('exam-institution')}</span></div><div class="detail-item"><span>备注:</span> <span>${val('notes')}</span></div></div>
                    <div class="detail-group"><h4>验光数据</h4><div class="detail-item"><span>裸眼视力 (OD/OS):</span> <span>${val('va-od')} / ${val('va-os')}</span></div><div class="detail-item"><span>电脑验光 (OD):</span> <span>${odArRx}</span></div><div class="detail-item"><span>电脑验光 (OS):</span> <span>${osArRx}</span></div><div class="detail-item"><span>综合验光 (OD):</span> <span>${odSrRx}</span></div><div class="detail-item"><span>综合验光 (OS):</span> <span>${osSrRx}</span></div><div class="detail-item"><span>矫正视力 (OD/OS):</span> <span>${val('cva-od')} / ${val('cva-os')}</span></div></div>
                    <div class="detail-group"><h4>生物学参数</h4><div class="detail-item"><span>测量设备:</span> <span>${val('bio-device')}</span></div><div class="detail-item"><span>眼轴 (OD/OS):</span> <span>${val('al-od')} / ${val('al-os')} mm</span></div><div class="detail-item"><span>ACD (OD/OS):</span> <span>${val('acd-od')} / ${val('acd-os')} mm</span></div><div class="detail-item"><span>CTT (OD/OS):</span> <span>${val('ctt-od')} / ${val('ctt-os')} μm</span></div><div class="detail-item"><span>AD (OD/OS):</span> <span>${val('ad-od')} / ${val('ad-os')} mm</span></div><div class="detail-item"><span>晶体厚度 (OD/OS):</span> <span>${val('lt-od')} / ${val('lt-os')} mm</span></div><div class="detail-item"><span>瞳孔直径 (OD/OS):</span> <span>${val('p-od')} / ${val('p-os')} mm</span></div><div class="detail-item"><span>曲率 K1/K2 (OD):</span> <span>${val('k1-od')} / ${val('k2-od')} D</span></div><div class="detail-item"><span>曲率 K1/K2 (OS):</span> <span>${val('k1-os')} / ${val('k2-os')} D</span></div></div>
                    <div class="detail-group"><h4>检查与筛查</h4><div class="detail-item"><span>Worth4点:</span> <span>${val('worth4')}</span></div><div class="detail-item"><span>立体视:</span> <span>${val('stereo')}</span></div></div>
                    <div class="detail-group"><h4>反应集合能力</h4><div class="detail-item"><span>远眼位 隐斜位:</span> <span>${val('far-phoria')}</span></div><div class="detail-item"><span>远距离融像 BO (B/B/R):</span> <span>${val('far-fus-bo-blur')} / ${val('far-fus-bo-break')} / ${val('far-fus-bo-rec')}</span></div><div class="detail-item"><span>远距离融像 BI (B/B/R):</span> <span>${val('far-fus-bi-blur')} / ${val('far-fus-bi-break')} / ${val('far-fus-bi-rec')}</span></div><div class="detail-item"><span>水平眼位(40cm) 隐斜位:</span> <span>${val('near-phoria')}</span></div><div class="detail-item"><span>AC/A比率:</span> <span>${val('ac-a-ratio')}</span></div><div class="detail-item"><span>+1.00D 水平眼位:</span> <span>${val('plus1-phoria')}</span></div><div class="detail-item"><span>40cm融像 BO (B/B/R):</span> <span>${val('near-fus-bo-blur')} / ${val('near-fus-bo-break')} / ${val('near-fus-bo-rec')}</span></div><div class="detail-item"><span>40cm融像 BI (B/B/R):</span> <span>${val('near-fus-bi-blur')} / ${val('near-fus-bi-break')} / ${val('near-fus-bi-rec')}</span></div></div>
                    <div class="detail-group"><h4>反应调节能力</h4><div class="detail-item"><span>NRA / PRA:</span> <span>${val('nra')} D / ${val('pra')} D</span></div><div class="detail-item"><span>调节反应 BCC (超前/滞后):</span> <span>${val('bcc-lead')} / ${val('bcc-lag')}</span></div><div class="detail-item"><span>集合近点 NPC:</span> <span>${val('npc')}</span></div><div class="detail-item"><span>附加球镜 ADD (公式法):</span> <span>${val('add-formula')} D</span></div><div class="detail-item"><span>调节幅度 AMP (镜片法):</span> <span>${val('amp-lens')} D</span></div><div class="detail-item"><span>调节灵敏度 Flipper (OD/OS/OU):</span> <span>${val('flipper-od')} / ${val('flipper-os')} / ${val('flipper-ou')} cpm</span></div></div>
                </div>
            `;
            modal.style.display = 'flex';
        };

        const exportToCSV = () => {
            if (records.length === 0) { alert('没有历史记录可导出。'); return; }
            const headers = formInputs.map(input => input.id).filter(id => id);
            const escapeCSV = (str) => `"${(str || '').replace(/"/g, '""')}"`;
            let csvContent = '\uFEFF' + headers.map(escapeCSV).join(',') + '\n';
            const sortedRecords = [...records].sort((a, b) => new Date(a['exam-date']) - new Date(b['exam-date']));
            sortedRecords.forEach(record => {
                const row = headers.map(header => escapeCSV(record[header]));
                csvContent += row.join(',') + '\n';
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `眼科检查记录-${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- New Feature: Share as PNG ---
        const shareAsPNG = async () => {
            const reportCard = document.getElementById('report-card-template');
            sharePngBtn.textContent = '正在生成...';
            sharePngBtn.disabled = true;

            // Populate report card from current form values
            document.getElementById('report-date').textContent = getInputValue('exam-date') || 'N/A';
            document.getElementById('report-institution').textContent = getInputValue('exam-institution') || 'N/A';
            document.getElementById('report-va').textContent = `${getInputValue('va-od') || '-'} / ${getInputValue('va-os') || '-'}`;
            document.getElementById('report-cva').textContent = `${getInputValue('cva-od') || '-'} / ${getInputValue('cva-os') || '-'}`;
            document.getElementById('report-ar-od').textContent = formatRx(getInputValue('ar-s-od'), getInputValue('ar-c-od'), getInputValue('ar-a-od'));
            document.getElementById('report-ar-os').textContent = formatRx(getInputValue('ar-s-os'), getInputValue('ar-c-os'), getInputValue('ar-a-os'));
            document.getElementById('report-sr-od').textContent = formatRx(getInputValue('sr-s-od'), getInputValue('sr-c-od'), getInputValue('sr-a-od'));
            document.getElementById('report-sr-os').textContent = formatRx(getInputValue('sr-s-os'), getInputValue('sr-c-os'), getInputValue('sr-a-os'));
            document.getElementById('report-al').textContent = `${getInputValue('al-od') || '-'} / ${getInputValue('al-os') || '-'} mm`;
            document.getElementById('report-k-od').textContent = `K1:${getInputValue('k1-od')||'-'} / K2:${getInputValue('k2-od')||'-'}`;
            document.getElementById('report-k-os').textContent = `K1:${getInputValue('k1-os')||'-'} / K2:${getInputValue('k2-os')||'-'}`;
            document.getElementById('report-ad').textContent = `${getInputValue('ad-od') || '-'} / ${getInputValue('ad-os') || '-'} mm`;

            try {
                const canvas = await html2canvas(reportCard, { scale: 2, useCORS: true });
                const link = document.createElement('a');
                link.download = `眼健康报告-${getInputValue('exam-date') || new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (error) {
                console.error('Error generating PNG:', error);
                alert('生成图片失败，请查看控制台获取更多信息。');
            } finally {
                sharePngBtn.textContent = '分享';
                sharePngBtn.disabled = false;
            }
        };

        // --- Event Listeners ---
        form.addEventListener('submit', handleFormSubmit);
        exportBtn.addEventListener('click', exportToCSV);
        sharePngBtn.addEventListener('click', shareAsPNG);

        historyTableBody.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = btn.dataset.id;
            if (btn.classList.contains('delete-btn')) {
                if (confirm('确定要删除这条记录吗？此操作不可撤销。')) {
                    records = records.filter(r => r.id != id);
                    saveRecords();
                    renderHistory();
                }
            } else if (btn.classList.contains('details-btn')) {
                showDetailsModal(id);
            }
        });

        closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
        window.addEventListener('click', (e) => { if (e.target == modal) modal.style.display = 'none'; });

        // Calculation logic listeners
        calcAdBtn.addEventListener('click', () => {
            ['od', 'os'].forEach(eye => {
                const acd = parseFloat(getInputValue(`acd-${eye}`));
                const ctt = parseFloat(getInputValue(`ctt-${eye}`));
                if (!isNaN(acd) && !isNaN(ctt)) {
                    setInputValue(`ad-${eye}`, (acd - (ctt / 1000)).toFixed(2));
                }
            });
        });
        calcAddBtn.addEventListener('click', () => {
            const nra = parseFloat(getInputValue('nra'));
            const pra = parseFloat(getInputValue('pra'));
            if (!isNaN(nra) && !isNaN(pra)) {
                setInputValue('add-formula', ((nra + Math.abs(pra)) / 2).toFixed(2));
            }
        });
        calcAmpBtn.addEventListener('click', () => {
            const pra = parseFloat(getInputValue('pra'));
            if (!isNaN(pra)) {
                setInputValue('amp-lens', (Math.abs(pra) + 2.50).toFixed(2));
            }
        });

        // --- Page Initialization ---
        setInputValue('exam-date', new Date().toISOString().split('T')[0]);
        renderHistory();
    });
    </script>
</body>
</html>
