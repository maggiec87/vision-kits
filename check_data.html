<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>检查记录</title>
    <style>
        :root {
            --primary-color: #00796b;
            --secondary-color: #4a5568;
            --background-color: #f4f5f7;
            --card-bg-color: #ffffff;
            --border-color: #e2e8f0;
            --input-bg-color: #f8f9fa;
            --success-color: #38a169;
            --danger-color: #e53e3e;
            --info-color: #3182ce;
            --warning-color: #f0ad4e;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--secondary-color);
            margin: 0;
            padding: 20px;
            -webkit-text-size-adjust: 100%;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--card-bg-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        h1, h2, h3, h4 {
            color: var(--primary-color);
            margin-top: 0;
        }
        h1, h2 { text-align: center; margin-bottom: 25px; }
        h3 { margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        h4 { margin-bottom: 10px; font-size: 1.1em; color: var(--secondary-color); }

        .header-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 15px; border: none; border-radius: 8px; font-size: 16px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            text-decoration: none; display: inline-block; text-align: center;
        }
        .btn-sm { padding: 5px 10px; font-size: 12px; border-radius: 6px; }
        .btn-primary { background-color: var(--primary-color); color: white; width: 100%; margin-top: 20px; }
        .btn-primary:hover { background-color: #005a4f; }
        .btn-secondary { background-color: #e2e8f0; color: #595959; }
        .btn-secondary:hover { background-color: #cbd5e0; }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: white; }
        .btn-calc { background-color: var(--warning-color); color: white; }

        form { display: flex; flex-direction: column; gap: 20px; }
        fieldset {
            border: 1px solid var(--border-color); border-radius: 8px; padding: 25px;
            margin: 0;
        }
        legend {
            font-weight: 600; font-size: 1.3em; color: var(--primary-color);
            padding: 0 10px; margin-left: 10px;
        }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-weight: 500; font-size: 0.9em; }
        label small { font-weight: 400; color: #777; margin-left: 5px; font-size: 0.9em; }
        input, select, textarea {
            padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;
            font-size: 16px; background-color: var(--input-bg-color); width: 100%;
            box-sizing: border-box;
        }
        textarea { resize: vertical; min-height: 80px; }
        
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
        .grid-dynamic { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        
        .input-group { display: flex; align-items: center; gap: 5px; }
        .input-group input { flex-grow: 1; }
        .input-group .btn-sm { flex-shrink: 0; }
        
        .history-section { margin-top: 40px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        #export-btn { background-color: var(--success-color); color: white; }
        
        .history-table { width: 100%; border-collapse: collapse; text-align: left; }
        .history-table th, .history-table td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; word-wrap: break-word; }
        .history-table th { font-weight: 600; background-color: #f8f9fa; }
        .history-table .actions-cell { text-align: right; white-space: nowrap; }
        .history-table .actions-cell .btn { margin-left: 5px; padding: 5px 10px; font-size: 14px; }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fff; margin: auto; padding: 20px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 800px;
            position: relative; max-height: 85vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; font-size: 1.5em; }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; border: none; background: none; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .detail-group { background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .detail-group h4 { margin: 0 0 10px 0; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .detail-item { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.95em; flex-wrap: wrap; }
        .detail-item span:first-child { font-weight: 600; color: var(--secondary-color); margin-right: 10px; }
        .detail-item span:last-child { text-align: right; flex-grow: 1; word-break: break-all; }

        details.collapsible-section {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0;
            transition: all 0.2s ease-in-out;
        }
        details.collapsible-section > summary {
            font-weight: 600;
            font-size: 1.3em;
            color: var(--primary-color);
            padding: 15px 20px;
            cursor: pointer;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        details.collapsible-section > summary::-webkit-details-marker { display: none; }
        details.collapsible-section > summary::after {
            content: '＋ 展开';
            font-size: 0.8em;
            color: var(--secondary-color);
            font-weight: 400;
            transition: transform 0.2s;
        }
        details[open] > summary::after {
            content: '－ 折叠';
        }
        details[open] > summary {
            border-bottom: 1px solid var(--border-color);
        }
        .collapsible-content {
            padding: 25px;
        }
        .collapsible-content fieldset {
            border: none;
            padding: 0;
        }
        .collapsible-content fieldset legend {
            display: none;
        }
        .section-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding: 0 25px 20px;
        }
        .section-actions .btn {
            flex-grow: 1;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px 15px; }
            .grid-2, .grid-3, .grid-4, .grid-dynamic { grid-template-columns: 1fr; }
            
            .compact-grid-3 { grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
            .compact-grid-2 { grid-template-columns: 1fr 1fr; gap: 10px; }

            .history-table { display: block; }
            .history-table thead { display: none; }
            .history-table tbody, .history-table tr, .history-table td { display: block; width: 100%; box-sizing: border-box; }
            .history-table tr {
                margin-bottom: 15px; border: 1px solid var(--border-color);
                border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 15px;
            }
            .history-table td {
                display: flex; justify-content: space-between; align-items: center;
                padding: 10px 5px; border: none; text-align: right;
                word-break: break-word;
            }
            .history-table td::before {
                content: attr(data-label); font-weight: 600; color: var(--primary-color);
                text-align: left; padding-right: 10px;
            }
            .history-table .actions-cell { justify-content: flex-end; padding-top: 15px; }
            .history-table .actions-cell::before { display: none; }
            .modal-content { width: 95%; max-height: 90vh; }
            .detail-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-nav">
            <h1>检查记录</h1>
            <div class="header-actions">
                <a href="https://maggiec87.github.io/vision-kits/" class="btn btn-secondary">HOME</a>
            </div>
        </div>

        <form id="exam-form">
            <!-- 基本信息 -->
            <fieldset>
                <legend>基本信息</legend>
                <div class="grid grid-dynamic">
                    <div class="form-group"><label for="exam-date">检查日期</label><input type="date" id="exam-date"></div>
                    <div class="form-group"><label for="exam-institution">检查机构</label><input type="text" id="exam-institution" placeholder="例如: 深圳市眼科医院"></div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="notes">备注</label>
                    <textarea id="notes" placeholder="其他需要记录的信息"></textarea>
                </div>
            </fieldset>

            <!-- 验光数据 -->
            <details class="collapsible-section" id="optometry-section">
                <summary>验光数据</summary>
                <div class="collapsible-content">
                    <fieldset>
                        <legend>验光数据</legend>
                        <div class="form-group">
                            <label>裸眼视力</label>
                            <div class="grid grid-2 compact-grid-2">
                               <input type="text" id="va-od" placeholder="OD (例如: 0.8 或 4.9)">
                               <input type="text" id="va-os" placeholder="OS (例如: 0.8 或 4.9)">
                            </div>
                        </div>
                        <h3 style="margin-top: 20px;">电脑验光</h3>
                        <div class="grid grid-2">
                            <div class="form-group"><label>右眼 (OD)</label><div class="grid grid-3 compact-grid-3"><input type="number" step="0.25" id="ar-s-od" placeholder="SPH"><input type="number" step="0.25" id="ar-c-od" placeholder="CYL"><input type="number" step="1" id="ar-a-od" placeholder="AX"></div></div>
                            <div class="form-group"><label>左眼 (OS)</label><div class="grid grid-3 compact-grid-3"><input type="number" step="0.25" id="ar-s-os" placeholder="SPH"><input type="number" step="0.25" id="ar-c-os" placeholder="CYL"><input type="number" step="1" id="ar-a-os" placeholder="AX"></div></div>
                        </div>
                        <h3 style="margin-top: 30px;">综合验光</h3>
                        <div class="grid grid-2">
                            <div class="form-group"><label>右眼 (OD)</label><div class="grid grid-3 compact-grid-3"><input type="number" step="0.25" id="sr-s-od" placeholder="SPH"><input type="number" step="0.25" id="sr-c-od" placeholder="CYL"><input type="number" step="1" id="sr-a-od" placeholder="AX"></div></div>
                            <div class="form-group"><label>左眼 (OS)</label><div class="grid grid-3 compact-grid-3"><input type="number" step="0.25" id="sr-s-os" placeholder="SPH"><input type="number" step="0.25" id="sr-c-os" placeholder="CYL"><input type="number" step="1" id="sr-a-os" placeholder="AX"></div></div>
                        </div>
                        <div class="form-group" style="margin-top: 20px;"><label>矫正视力</label><div class="grid grid-2 compact-grid-2"><input type="text" id="cva-od" placeholder="OD (例如: 1.0 或 5.0)"><input type="text" id="cva-os" placeholder="OS (例如: 1.0 或 5.0)"></div></div>
                    </fieldset>
                </div>
                <div class="section-actions">
                    <button type="button" class="btn btn-info btn-sm" data-action="save-section" data-section="optometry">保存</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-action="export-section" data-section="optometry">导出</button>
                </div>
            </details>

            <!-- 生物测量数据 -->
            <details class="collapsible-section" id="biometry-section">
                <summary>生物测量数据</summary>
                <div class="collapsible-content">
                    <fieldset>
                        <legend>生物测量数据</legend>
                        <div class="form-group"><label for="bio-device">测量设备</label><select id="bio-device"><option value="">-- 请选择 --</option><option value="蔡司700">蔡司700</option><option value="蔡司500">蔡司500</option><option value="索维">索维(Suowei)</option><option value="尼德克">尼德克(Nidek)</option><option value="其他">其他</option></select></div>
                        <div class="grid grid-dynamic" style="margin-top: 20px;">
                            <div class="form-group"><label>眼轴 (AL, mm)</label><div class="grid grid-2 compact-grid-2"><input type="number" step="0.01" id="al-od" placeholder="OD"><input type="number" step="0.01" id="al-os" placeholder="OS"></div></div>
                            <div class="form-group"><label>晶体厚度 (LT, mm)</label><div class="grid grid-2 compact-grid-2"><input type="number" step="0.01" id="lt-od" placeholder="OD"><input type="number" step="0.01" id="lt-os" placeholder="OS"></div></div>
                            <div class="form-group"><label>瞳孔直径 (P, mm)</label><div class="grid grid-2 compact-grid-2"><input type="number" step="0.1" id="p-od" placeholder="OD"><input type="number" step="0.1" id="p-os" placeholder="OS"></div></div>
                        </div>
                        <div class="grid grid-3" style="margin-top: 20px;">
                            <div class="form-group"><label>ACD (mm)</label><div class="grid grid-2 compact-grid-2"><input type="number" step="0.01" id="acd-od" placeholder="OD"><input type="number" step="0.01" id="acd-os" placeholder="OS"></div></div>
                            <div class="form-group"><label>角膜厚度 (CTT, μm)</label><div class="grid grid-2 compact-grid-2"><input type="number" id="ctt-od" placeholder="OD"><input type="number" id="ctt-os" placeholder="OS"></div></div>
                            <div class="form-group"><label>前房深度 (AD, mm)</label><div class="input-group"><div class="grid grid-2 compact-grid-2" style="flex-grow:1;"><input type="number" step="0.01" id="ad-od" placeholder="OD"><input type="number" step="0.01" id="ad-os" placeholder="OS"></div><button type="button" id="calc-ad-btn" class="btn btn-sm btn-calc">计算</button></div></div>
                        </div>
                        <div class="form-group" style="margin-top: 20px;"><label>曲率 (K, D)</label><div class="grid grid-4"><input type="number" step="0.01" id="k1-od" placeholder="OD K1"><input type="number" step="0.01" id="k2-od" placeholder="OD K2"><input type="number" step="0.01" id="k1-os" placeholder="OS K1"><input type="number" step="0.01" id="k2-os" placeholder="OS K2"></div></div>
                    </fieldset>
                </div>
                <div class="section-actions">
                    <button type="button" class="btn btn-info btn-sm" data-action="save-section" data-section="biometry">保存</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-action="export-section" data-section="biometry">导出</button>
                </div>
            </details>
            
            <!-- 视功能数据 -->
            <details class="collapsible-section" id="visual-function-section">
                <summary>视功能数据</summary>
                <div class="collapsible-content">
                    <fieldset>
                        <legend>视功能</legend>
                        <h3>双眼视</h3>
                        <div class="grid grid-dynamic"><div class="form-group"><label for="worth4">Worth4点</label><input type="text" id="worth4" placeholder="正常: 4点"></div><div class="form-group"><label for="stereo">立体视</label><input type="text" id="stereo" placeholder="正常: ≤60秒"></div></div>
                        <h3 style="margin-top: 30px;">反应集合能力</h3>
                        <div class="grid grid-dynamic">
                            <div class="form-group"><label>远眼位 隐斜位</label><input type="text" id="far-phoria" placeholder="例: 1△EP"></div>
                            <div class="form-group"><label>远融像(BO)<small>(B/B/R)</small></label><div class="grid grid-3 compact-grid-3"><input type="text" id="far-fus-bo-blur" placeholder="模糊"><input type="text" id="far-fus-bo-break" placeholder="破裂"><input type="text" id="far-fus-bo-rec" placeholder="恢复"></div></div>
                            <div class="form-group"><label>远融像(BI)<small>(B/B/R)</small></label><div class="grid grid-3 compact-grid-3"><input type="text" id="far-fus-bi-blur" placeholder="模糊"><input type="text" id="far-fus-bi-break" placeholder="破裂"><input type="text" id="far-fus-bi-rec" placeholder="恢复"></div></div>
                            <div class="form-group"><label>近眼位(40cm) 隐斜位</label><input type="text" id="near-phoria" placeholder="例: 3△EP"></div>
                            <div class="form-group"><label>AC/A比率</label><input type="text" id="ac-a-ratio" placeholder="正常: 4±2 △/D"></div>
                            <div class="form-group"><label>+1.00D 水平眼位</label><input type="text" id="plus1-phoria" placeholder="BI/BO/值 (△)"></div>
                            <div class="form-group"><label>近融像(BO)<small>(B/B/R)</small></label><div class="grid grid-3 compact-grid-3"><input type="text" id="near-fus-bo-blur" placeholder="模糊"><input type="text" id="near-fus-bo-break" placeholder="破裂"><input type="text" id="near-fus-bo-rec" placeholder="恢复"></div></div>
                            <div class="form-group"><label>近融像(BI)<small>(B/B/R)</small></label><div class="grid grid-3 compact-grid-3"><input type="text" id="near-fus-bi-blur" placeholder="模糊"><input type="text" id="near-fus-bi-break" placeholder="破裂"><input type="text" id="near-fus-bi-rec" placeholder="恢复"></div></div>
                        </div>
                        <h3 style="margin-top: 30px;">反应调节能力</h3>
                        <div class="grid grid-dynamic">
                            <div class="form-group"><label>NRA</label><input type="number" step="0.25" id="nra" placeholder="正常: +2.00±0.50D"></div>
                            <div class="form-group"><label>PRA</label><input type="number" step="0.25" id="pra" placeholder="正常: -2.37±1.00D"></div>
                            <div class="form-group"><label>调节反应BCC</label><div class="grid grid-2 compact-grid-2"><input type="text" id="bcc-lead" placeholder="超前 -_D"><input type="text" id="bcc-lag" placeholder="滞后 (正常: +0.50~+0.75D)"></div></div>
                            <div class="form-group"><label>集合近点(NPC)</label><input type="text" id="npc" placeholder="正常: ≤5cm/7cm"></div>
                        </div>
                        <div class="grid grid-dynamic" style="margin-top: 20px;"><div class="form-group"><label>ADD(公式法)</label><div class="input-group"><input type="text" id="add-formula" placeholder="结果 (D)" readonly><button type="button" id="calc-add-btn" class="btn btn-sm btn-calc">计算</button></div></div><div class="form-group"><label>AMP(镜片法)</label><div class="input-group"><input type="text" id="amp-lens" placeholder="结果 (D)" readonly><button type="button" id="calc-amp-btn" class="btn btn-sm btn-calc">计算</button></div></div></div>
                        <div class="form-group" style="margin-top: 20px;"><label>调节灵敏度(cpm)</label><div class="grid grid-3 compact-grid-3"><input type="number" id="flipper-od" placeholder="OD"><input type="number" id="flipper-os" placeholder="OS"><input type="number" id="flipper-ou" placeholder="OU"></div></div>
                    </fieldset>
                </div>
                <div class="section-actions">
                    <button type="button" class="btn btn-info btn-sm" data-action="save-section" data-section="visual-function">保存</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-action="export-section" data-section="visual-function">导出</button>
                </div>
            </details>

            <button type="submit" class="btn btn-primary">保存全部</button>
        </form>

        <!-- 历史 -->
        <div class="history-section">
            <div class="history-header"><h2>历史</h2><button id="export-btn" class="btn">导出全部</button></div>
            <table class="history-table"><thead><tr><th>日期</th><th>机构</th><th>眼轴(OD/OS)</th><th>综合验光(OD/OS)</th><th class="actions-cell">操作</th></tr></thead><tbody id="history-table-body"></tbody></table>
        </div>
    </div>

    <!-- 详情弹窗 -->
    <div id="details-modal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="modal-title">检查详情</h3><span class="close-btn">&times;</span></div><div id="modal-body"></div></div></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element Selectors ---
        const form = document.getElementById('exam-form');
        const submitBtn = form.querySelector('button[type="submit"]');
        const historyTableBody = document.getElementById('history-table-body');
        const exportBtn = document.getElementById('export-btn');
        const modal = document.getElementById('details-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.querySelector('.close-btn');
        
        const calcAdBtn = document.getElementById('calc-ad-btn');
        const calcAddBtn = document.getElementById('calc-add-btn');
        const calcAmpBtn = document.getElementById('calc-amp-btn');

        const DB_KEY = 'eyeExamRecords_v7'; // Updated version key
        let records = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        let editingRecordId = null;
        const formInputs = Array.from(form.querySelectorAll('input, textarea, select'));

        const SECTION_CONFIG = {
            'optometry': {
                dbKey: 'eyeExam_optometry_records',
                name: '验光数据',
                fields: ['exam-date', 'exam-institution', 'va-od', 'va-os', 'ar-s-od', 'ar-c-od', 'ar-a-od', 'ar-s-os', 'ar-c-os', 'ar-a-os', 'sr-s-od', 'sr-c-od', 'sr-a-od', 'sr-s-os', 'sr-c-os', 'sr-a-os', 'cva-od', 'cva-os']
            },
            'biometry': {
                dbKey: 'eyeExam_biometry_records',
                name: '生物测量数据',
                fields: ['exam-date', 'exam-institution', 'bio-device', 'al-od', 'al-os', 'lt-od', 'lt-os', 'p-od', 'p-os', 'acd-od', 'acd-os', 'ctt-od', 'ctt-os', 'ad-od', 'ad-os', 'k1-od', 'k2-od', 'k1-os', 'k2-os']
            },
            'visual-function': {
                dbKey: 'eyeExam_visual_function_records',
                name: '视功能数据',
                fields: ['exam-date', 'exam-institution', 'worth4', 'stereo', 'far-phoria', 'far-fus-bo-blur', 'far-fus-bo-break', 'far-fus-bo-rec', 'far-fus-bi-blur', 'far-fus-bi-break', 'far-fus-bi-rec', 'near-phoria', 'ac-a-ratio', 'plus1-phoria', 'near-fus-bo-blur', 'near-fus-bo-break', 'near-fus-bo-rec', 'near-fus-bi-blur', 'near-fus-bi-break', 'near-fus-bi-rec', 'nra', 'pra', 'bcc-lead', 'bcc-lag', 'npc', 'add-formula', 'amp-lens', 'flipper-od', 'flipper-os', 'flipper-ou']
            }
        };
        
        // --- Utility Functions ---
        const saveRecords = () => localStorage.setItem(DB_KEY, JSON.stringify(records));
        const getInputValue = (id) => document.getElementById(id).value;
        const setInputValue = (id, value) => {
            const el = document.getElementById(id);
            if (el) {
                el.value = value || '';
            }
        };

        const formatRx = (s, c, a, placeholder = '-') => {
            if (!s && !c && !a) return placeholder;
            let s_val = parseFloat(s);
            let c_val = parseFloat(c);
            let rx = !isNaN(s_val) ? s_val.toFixed(2) : '0.00';
            if (!isNaN(c_val) && c_val !== 0) {
                rx += ` / ${c_val.toFixed(2)} x ${a || '0'}`;
            }
            return rx;
        };
        
        const escapeCSV = (str) => `"${(str || '').replace(/"/g, '""')}"`;

        // --- Core Logic: History, Form, Modal ---
        const renderHistory = () => {
            historyTableBody.innerHTML = '';
            [...records].sort((a, b) => new Date(b['exam-date']) - new Date(a['exam-date'])).forEach(rec => {
                const tr = document.createElement('tr');
                const na = '无';
                const odRx = formatRx(rec['sr-s-od'], rec['sr-c-od'], rec['sr-a-od']);
                const osRx = formatRx(rec['sr-s-os'], rec['sr-c-os'], rec['sr-a-os']);
                tr.innerHTML = `
                    <td data-label="日期">${rec['exam-date'] || na}</td>
                    <td data-label="机构">${rec['exam-institution'] || na}</td>
                    <td data-label="眼轴">${rec['al-od'] || '-'}/${rec['al-os'] || '-'}</td>
                    <td data-label="综合验光">${odRx} / ${osRx}</td>
                    <td class="actions-cell">
                        <button class="btn btn-info details-btn" data-id="${rec.id}">详情</button>
                        <button class="btn btn-warning edit-btn" data-id="${rec.id}">修改</button>
                        <button class="btn btn-danger delete-btn" data-id="${rec.id}">删除</button>
                    </td>
                `;
                historyTableBody.appendChild(tr);
            });
        };

        const resetFormAndState = () => {
            form.reset();
            setInputValue('exam-date', new Date().toISOString().split('T')[0]);
            editingRecordId = null;
            submitBtn.textContent = '保存全部';
            document.querySelectorAll('.collapsible-section').forEach(d => d.open = false);
        };

        const loadRecordIntoForm = (recordId) => {
            const record = records.find(r => r.id == recordId);
            if (!record) return;

            editingRecordId = record.id;
            formInputs.forEach(input => {
                if (input.id) {
                    setInputValue(input.id, record[input.id]);
                }
            });

            if (Object.keys(record).some(k => k.startsWith('sr-') || k.startsWith('ar-'))) {
                document.getElementById('optometry-section').open = true;
            }
            if (Object.keys(record).some(k => k.startsWith('al-') || k.startsWith('k1-'))) {
                 document.getElementById('biometry-section').open = true;
            }
            if (Object.keys(record).some(k => k.startsWith('far-') || k.startsWith('nra'))) {
                 document.getElementById('visual-function-section').open = true;
            }

            submitBtn.textContent = '更新全部';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        const handleFormSubmit = (e) => {
            e.preventDefault();
            
            const recordData = {};
            formInputs.forEach(input => { 
                if (input.id) {
                    recordData[input.id] = input.value; 
                }
            });

            if (editingRecordId) {
                const recordIndex = records.findIndex(r => r.id === editingRecordId);
                if (recordIndex > -1) {
                    records[recordIndex] = { ...records[recordIndex], ...recordData };
                    alert('检查记录已更新！');
                }
            } else {
                recordData.id = Date.now();
                records.push(recordData);
                alert('检查记录已保存！');
            }
            
            saveRecords();
            renderHistory();
            resetFormAndState();
        };
        
        const showDetailsModal = (recordId) => {
            const record = records.find(r => r.id == recordId);
            if (!record) return;
            const na = 'N/A';
            const val = (key) => record[key] || na;
            
            const odArRx = formatRx(val('ar-s-od'), val('ar-c-od'), val('ar-a-od'));
            const osArRx = formatRx(val('ar-s-os'), val('ar-c-os'), val('ar-a-os'));
            const odSrRx = formatRx(val('sr-s-od'), val('sr-c-od'), val('sr-a-od'));
            const osSrRx = formatRx(val('sr-s-os'), val('sr-c-os'), val('sr-a-os'));

            modalTitle.textContent = `检查详情 - ${val('exam-date')}`;
            modalBody.innerHTML = `
                <div class="detail-grid">
                    <div class="detail-group"><h4>基本信息</h4><div class="detail-item"><span>检查日期:</span> <span>${val('exam-date')}</span></div><div class="detail-item"><span>检查机构:</span> <span>${val('exam-institution')}</span></div><div class="detail-item"><span>备注:</span> <span>${val('notes')}</span></div></div>
                    <div class="detail-group"><h4>验光数据</h4><div class="detail-item"><span>裸眼视力 (OD/OS):</span> <span>${val('va-od')} / ${val('va-os')}</span></div><div class="detail-item"><span>电脑验光 (OD):</span> <span>${odArRx}</span></div><div class="detail-item"><span>电脑验光 (OS):</span> <span>${osArRx}</span></div><div class="detail-item"><span>综合验光 (OD):</span> <span>${odSrRx}</span></div><div class="detail-item"><span>综合验光 (OS):</span> <span>${osSrRx}</span></div><div class="detail-item"><span>矫正视力 (OD/OS):</span> <span>${val('cva-od')} / ${val('cva-os')}</span></div></div>
                    <div class="detail-group"><h4>生物学参数</h4><div class="detail-item"><span>测量设备:</span> <span>${val('bio-device')}</span></div><div class="detail-item"><span>眼轴 (OD/OS):</span> <span>${val('al-od')} / ${val('al-os')} mm</span></div><div class="detail-item"><span>ACD (OD/OS):</span> <span>${val('acd-od')} / ${val('acd-os')} mm</span></div><div class="detail-item"><span>CTT (OD/OS):</span> <span>${val('ctt-od')} / ${val('ctt-os')} μm</span></div><div class="detail-item"><span>AD (OD/OS):</span> <span>${val('ad-od')} / ${val('ad-os')} mm</span></div><div class="detail-item"><span>晶体厚度 (OD/OS):</span> <span>${val('lt-od')} / ${val('lt-os')} mm</span></div><div class="detail-item"><span>瞳孔直径 (OD/OS):</span> <span>${val('p-od')} / ${val('p-os')} mm</span></div><div class="detail-item"><span>曲率 K1/K2 (OD):</span> <span>${val('k1-od')} / ${val('k2-od')} D</span></div><div class="detail-item"><span>曲率 K1/K2 (OS):</span> <span>${val('k1-os')} / ${val('k2-os')} D</span></div></div>
                    <div class="detail-group"><h4>视功能</h4><div class="detail-item"><span>Worth4点:</span> <span>${val('worth4')}</span></div><div class="detail-item"><span>立体视:</span> <span>${val('stereo')}</span></div><div class="detail-item"><span>远眼位 隐斜位:</span> <span>${val('far-phoria')}</span></div><div class="detail-item"><span>近眼位(40cm) 隐斜位:</span> <span>${val('near-phoria')}</span></div><div class="detail-item"><span>NRA / PRA:</span> <span>${val('nra')} D / ${val('pra')} D</span></div><div class="detail-item"><span>集合近点 NPC:</span> <span>${val('npc')}</span></div></div>
                </div>
            `;
            modal.style.display = 'flex';
        };

        const exportToCSV = (data, headers, fileName) => {
            if (data.length === 0) { alert('没有记录可导出。'); return; }
            let csvContent = '\uFEFF' + headers.map(escapeCSV).join(',') + '\n';
            const sortedData = [...data].sort((a, b) => new Date(a['exam-date']) - new Date(b['exam-date']));
            sortedData.forEach(record => {
                const row = headers.map(header => escapeCSV(record[header]));
                csvContent += row.join(',') + '\n';
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `${fileName}-${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- Event Listeners ---
        form.addEventListener('submit', handleFormSubmit);
        
        exportBtn.addEventListener('click', () => {
            const allHeaders = formInputs.map(input => input.id).filter(id => id);
            exportToCSV(records, allHeaders, '眼科检查记录-全部');
        });

        historyTableBody.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = btn.dataset.id;
            if (btn.classList.contains('delete-btn')) {
                if (confirm('确定要删除这条记录吗？此操作不可撤销。')) {
                    records = records.filter(r => r.id != id);
                    saveRecords();
                    renderHistory();
                }
            } else if (btn.classList.contains('details-btn')) {
                showDetailsModal(id);
            } else if (btn.classList.contains('edit-btn')) {
                loadRecordIntoForm(id);
            }
        });

        form.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-action]');
            if (!btn) return;

            const action = btn.dataset.action;
            const sectionKey = btn.dataset.section;
            const config = SECTION_CONFIG[sectionKey];
            if (!config) return;

            if (action === 'save-section') {
                const sectionData = { id: Date.now() };
                config.fields.forEach(fieldId => {
                    sectionData[fieldId] = getInputValue(fieldId);
                });
                
                let sectionRecords = JSON.parse(localStorage.getItem(config.dbKey)) || [];
                sectionRecords.push(sectionData);
                localStorage.setItem(config.dbKey, JSON.stringify(sectionRecords));
                alert(`${config.name} 已独立保存！`);
            } 
            else if (action === 'export-section') {
                let sectionRecords = JSON.parse(localStorage.getItem(config.dbKey)) || [];
                if (sectionRecords.length === 0) {
                    alert(`没有独立的 ${config.name} 记录可导出。`);
                    return;
                }
                exportToCSV(sectionRecords, config.fields, `独立记录-${config.name}`);
            }
        });

        closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
        window.addEventListener('click', (e) => { if (e.target == modal) modal.style.display = 'none'; });

        // Calculation logic listeners
        calcAdBtn.addEventListener('click', () => {
            ['od', 'os'].forEach(eye => {
                const acd = parseFloat(getInputValue(`acd-${eye}`));
                const ctt = parseFloat(getInputValue(`ctt-${eye}`));
                if (!isNaN(acd) && !isNaN(ctt)) {
                    setInputValue(`ad-${eye}`, (acd - (ctt / 1000)).toFixed(2));
                }
            });
        });
        calcAddBtn.addEventListener('click', () => {
            const nra = parseFloat(getInputValue('nra'));
            const pra = parseFloat(getInputValue('pra'));
            if (!isNaN(nra) && !isNaN(pra)) {
                setInputValue('add-formula', ((nra + Math.abs(pra)) / 2).toFixed(2));
            }
        });
        calcAmpBtn.addEventListener('click', () => {
            const pra = parseFloat(getInputValue('pra'));
            if (!isNaN(pra)) {
                setInputValue('amp-lens', (Math.abs(pra) + 2.50).toFixed(2));
            }
        });

        // --- Page Initialization ---
        resetFormAndState();
        renderHistory();
    });
    </script>
</body>
</html>
