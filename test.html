<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>视力测试中</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* 针对移动端中心按钮的内联样式补充 */
        #mobile-btn-menu {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }
        #mobile-btn-menu svg {
            width: 24px; 
            height: 24px;
            margin-bottom: 2px;
        }
        #mobile-btn-menu span {
            font-size: 12px;
            line-height: 1;
            font-weight: bold;
        }
        .directional-pad-container {
            gap: 8px; 
        }
        
        /* --- 电视兼容性焦点样式 (已更新) --- */
        button:focus, .theme-buttons .btn:focus { /* 确保焦点样式 */
            outline: 3px solid #FFD700; /* 金色边框 */
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            z-index: 1001; /* 确保焦点在最上层 */
        }

        /* 历史记录样式 */
        .eval-text {
            font-weight: bold;
            margin: 10px 0;
        }
        .text-green { color: #4CAF50; }
        .text-red { color: #f44336; }
        .text-yellow { color: #FF9800; }

        /* --- 主题样式 (通常应在 style.css 中，这里为了演示方便保留) --- */
        body {
            background-color: #f0f0f0; /* 默认背景 */
            color: #333; /* 默认文字颜色 */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.theme-paper { background-color: #fdf6e3; color: #586e75; }
        body.theme-eyecare { background-color: #e0f2f1; color: #263238; }
        body.theme-bright { background-color: #ffffff; color: #000000; }
        body.theme-dark { background-color: #282c34; color: #abb2bf; }
        
        /* 模态框背景和文字颜色也需要适配主题 */
        .modal-content {
            background-color: #fff;
            color: #333;
        }
        body.theme-dark .modal-content {
            background-color: #3e444f;
            color: #abb2bf;
        }
        body.theme-dark .modal-actions .btn {
             background-color: #555;
             color: #eee;
             border-color: #666;
        }
        body.theme-dark .modal-actions .btn.bg-red {
            background-color: #d32f2f;
        }
        body.theme-dark .modal-actions .btn.bg-blue {
            background-color: #1976d2;
        }
        body.theme-dark .modal-actions .btn.bg-gray {
            background-color: #757575;
        }

        /* --- 新增的预测试配置界面样式 --- */
        #pre-test-config {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* 半透明背景 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: #fff;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        #pre-test-config .config-panel {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: #333;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.theme-dark #pre-test-config .config-panel {
            background-color: #3e444f;
            color: #abb2bf;
        }
        body.theme-paper #pre-test-config .config-panel {
            background-color: #fff8e8;
            color: #586e75;
        }
        body.theme-eyecare #pre-test-config .config-panel {
            background-color: #ffffff;
            color: #263238;
        }
        #pre-test-config h2 {
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.8em;
            color: inherit;
        }
        #pre-test-config .theme-buttons {
            margin-top: 20px;
            margin-bottom: 30px;
        }
        #pre-test-config .btn-start-test {
            padding: 15px 40px;
            font-size: 1.2em;
            background-color: #28a745;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        #pre-test-config .btn-start-test:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        /* 主题选择按钮样式 */
        .theme-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .theme-buttons .btn {
            min-width: 80px;
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #eee;
            color: #333;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
        }
        .theme-buttons .btn.active-theme {
            border-color: #4CAF50; /* 选中主题的边框颜色 */
            background-color: #e8f5e9; /* 选中主题的背景颜色 */
            color: #4CAF50; /* 选中主题的文字颜色 */
            font-weight: bold;
        }

        /* --------------------------------------------------- */
        /* 新增：媒体查询，在大屏幕上隐藏移动端控制面板 */
        /* --------------------------------------------------- */
        .mobile-controls-panel {
            display: flex; /* 默认在小屏幕上显示 */
        }

        @media (min-width: 768px) { /* 768px 通常是平板电脑的最小宽度 */
            .mobile-controls-panel {
                display: none !important; /* 在大屏幕上强制隐藏 */
            }
        }
        /* --------------------------------------------------- */
        /* --------------------------------------------------- */
    </style>
</head>
<!-- 添加 tabindex="0" 让 body 可聚焦，捕获电视按键 -->
<body tabindex="0">
    <!-- SVG 图标定义文件 -->
    <div style="display: none;">
        <object type="image/svg+xml" data="icons.svg"></object>
    </div>

    <!-- 预测试配置界面 -->
    <div id="pre-test-config">
        <div class="config-panel">
            <h2>选择视觉模式</h2>
            <div class="theme-buttons">
                <button class="btn theme-btn" data-theme="paper">纸模</button>
                <button class="btn theme-btn" data-theme="eyecare">护眼</button>
                <button class="btn theme-btn" data-theme="bright">亮白</button>
                <button class="btn theme-btn" data-theme="dark">暗黑</button>
            </div>
            <button id="start-test-from-config" class="btn btn-start-test">开始测试</button>
        </div>
    </div>

    <!-- 测试页 (初始隐藏) -->
    <div id="page-test" class="page" style="display: none;">
        <header class="test-header">
            <div id="test-title" class="test-title"></div>
            <div class="test-info">
                <div id="timer-display"><span>计时:</span> <span id="test-timer">0</span>s</div>
                <div><span>得分:</span> <span id="test-score">0/0</span></div>
            </div>
        </header>
        <main class="test-main">
            <div id="e-chart-container">
                <svg id="e-chart-svg" viewBox="0 0 5 5">
                    <path d="M0,0 H5 V1 H1 V2 H5 V3 H1 V4 H5 V5 H0 Z" fill="currentColor"/>
                </svg>
            </div>
        </main>
        
        <!-- === 移动端专属控制面板 === -->
        <!-- 注意：这里的 style="display: none;" 只是初始状态，JS会根据设备类型决定是否显示 -->
        <div class="mobile-controls-panel" style="display: none;"> 
            <div class="directional-pad-container">
                <button class="mobile-control-btn touch-btn btn-dir-up" data-dir="up"><svg><use href="icons.svg#icon-up"/></svg></button>
                <button class="mobile-control-btn touch-btn btn-dir-left" data-dir="left"><svg><use href="icons.svg#icon-left"/></svg></button>
                <button id="mobile-btn-menu" class="mobile-control-btn bg-yellow" style="grid-area: 2 / 2 / 3 / 3;">
                    <svg><use href="icons.svg#icon-menu"/></svg>
                    <span>暂停</span>
                </button>
                <button class="mobile-control-btn touch-btn btn-dir-right" data-dir="right"><svg><use href="icons.svg#icon-right"/></svg></button>
                <button class="mobile-control-btn touch-btn btn-dir-down" data-dir="down"><svg><use href="icons.svg#icon-down"/></svg></button>
            </div>
        </div>
    </div>

    <!-- 菜单/结果弹窗 -->
    <div id="result-modal" style="display: none;">
        <div class="modal-content">
            <h2 id="modal-title">已暂停</h2>
            <div id="modal-body"></div>
            
            <div id="modal-actions" class="modal-actions">
                <button id="modal-btn-end" class="btn bg-red">结束</button>
                <button id="modal-btn-continue" class="btn bg-blue">继续</button>
                <button id="modal-btn-exit" class="btn bg-gray">退出</button>
            </div>
        </div>
    </div>


    <!-- 
        您的主脚本逻辑。
        请确保此处的 handleRemoteControl 函数已经更新，
        以支持对主题切换器的遥控器操作。
    -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 电视焦点初始化 ---
            document.body.focus();

            // --- 数据和常量 ---
            const DIRECTIONS = ['up', 'down', 'left', 'right'];
            const KEY_MAP = { ArrowUp: 'up', ArrowDown: 'down', ArrowLeft: 'left', ArrowRight: 'right' };
            const ROTATION_MAP = { up: -90, down: 90, left: 180, right: 0 };

            // --- 应用状态 ---
            let appState = {
                testConfig: null,
                testState: { status: 'idle', timer: 0, correct: 0, total: 0, currentE: null, type: null },
                timerInterval: null,
                currentView: 'pre-test-config' // 新增状态，表示当前显示哪个界面
            };

            // --- 主题管理 ---
            let currentTheme = localStorage.getItem('selectedTheme') || 'bright'; // 默认主题
            const themeButtons = document.querySelectorAll('.theme-btn');

            function applyTheme(themeName) {
                document.body.className = ''; // 清除所有主题类
                document.body.classList.add(`theme-${themeName}`);
                localStorage.setItem('selectedTheme', themeName);
                currentTheme = themeName;
                
                // 更新主题按钮的激活状态
                themeButtons.forEach(btn => {
                    if (btn.dataset.theme === themeName) {
                        btn.classList.add('active-theme');
                    } else {
                        btn.classList.remove('active-theme');
                    }
                });
            }

            // --- DOM 元素引用 ---
            const preTestConfigDiv = document.getElementById('pre-test-config');
            const startTestFromConfigBtn = document.getElementById('start-test-from-config');
            const pageTestDiv = document.getElementById('page-test');
            const mobileControlsPanel = document.querySelector('.mobile-controls-panel'); // 获取移动端控制面板

            const eChartEl = document.getElementById('e-chart-svg');
            const testTimerEl = document.getElementById('test-timer');
            const testScoreEl = document.getElementById('test-score');
            const resultModal = document.getElementById('result-modal');
            const timerDisplay = document.getElementById('timer-display');

            // --- 判断是否为移动设备 (基于屏幕宽度) ---
            function isMobileDevice() {
                return window.matchMedia("(max-width: 767px)").matches; // 767px 及以下认为是移动设备
            }
            
            // --- 核心功能函数 ---
            function renderEChart(sizePx, direction) {
                eChartEl.style.width = `${sizePx}px`;
                eChartEl.style.height = `${sizePx}px`;
                eChartEl.style.transform = `rotate(${ROTATION_MAP[direction]}deg)`;
            }

            function generateRandomE(level) {
                const randomDirection = DIRECTIONS[Math.floor(Math.random() * DIRECTIONS.length)];
                return { level, direction: randomDirection };
            }

            function startTest(config) {
                appState.testConfig = config;
                let initialE;
                if (config.type === 'baseline') {
                    initialE = generateRandomE(config.level);
                    timerDisplay.style.display = 'none'; 
                } else { 
                    const levels = [...config.fogLevels, config.minLevel];
                    const randomLevel = levels[Math.floor(Math.random() * levels.length)];
                    initialE = generateRandomE(randomLevel);
                    timerDisplay.style.display = 'block';
                }
                
                const initialTimer = config.type === 'baseline' ? 0 : 60;

                appState.testState = { status: 'running', timer: initialTimer, correct: 0, total: 0, currentE: initialE, type: config.type };
                updateTestUI();
                
                if (config.type === 'fogging') {
                    startTimer();
                }
            }
            
            function startTimer() {
                if (appState.timerInterval) clearInterval(appState.timerInterval);
                appState.timerInterval = setInterval(() => {
                    if (appState.testState.status !== 'running') return;
                    
                    appState.testState.timer--;
                    testTimerEl.textContent = appState.testState.timer;
                    
                    if (appState.testState.timer <= 0) {
                        clearInterval(appState.timerInterval);
                        appState.testState.status = 'paused';
                        showFinalResult();
                    }
                }, 1000);
            }

            function handleAnswer(answer) {
                if (appState.testState.status !== 'running') return;
                const state = appState.testState;
                const config = appState.testConfig;
                
                state.correct += (answer === state.currentE.direction ? 1 : 0);
                state.total += 1;

                if (state.type === 'baseline' && state.total >= 10) {
                    updateTestUI();
                    evaluateBaselineResult();
                    return;
                }

                let nextE;
                if (state.type === 'baseline') {
                    nextE = generateRandomE(config.level);
                } else {
                    const isNextMinLevel = (state.total + 1) % 2 !== 0;
                    const levelToUse = isNextMinLevel ? config.minLevel : config.fogLevels[Math.floor(Math.random() * config.fogLevels.length)];
                    nextE = generateRandomE(levelToUse);
                }
                state.currentE = nextE;
                updateTestUI();
            }

            function evaluateBaselineResult() {
                clearInterval(appState.timerInterval);
                appState.testState.status = 'paused';
                
                const { correct } = appState.testState;
                let title = "基准测试完成";
                let message = `<p>得分: <strong>${correct}/10</strong></p>`;
                
                if (correct >= 8) {
                    message += `<p class="eval-text text-green">✔ 视标合适</p><p>准确率达标，可进行雾视挑战</p>`;
                } else if (correct <= 6) {
                    message += `<p class="eval-text text-red">✘ 建议换大一级</p><p>准确率过低，请调整视标重测。</p>`;
                } else {
                    message += `<p class="eval-text text-yellow">⚠ 建议重测</p><p>处于临界值，建议再测一次。</p>`;
                }
                showFinalResult(title, message);
            }

            function showFinalResult(title = null, customBody = null) {
                clearInterval(appState.timerInterval);
                appState.testState.status = 'paused';
                resultModal.style.display = 'flex';
                appState.currentView = 'result-modal'; // 更新当前视图状态
                
                const { correct, total, type } = appState.testState;
                const config = appState.testConfig;
                const level = type === 'baseline' ? config?.level?.decimal : config?.minLevel?.decimal;
			
                if (!title) {
                    title = type === 'baseline' ? '基准测试完成' : '雾视挑战完成';
                }
                document.getElementById('modal-title').textContent = title;

                if (!customBody) {
                    const accuracy = total > 0 ? ((correct / total) * 100).toFixed(1) : 0;
                    customBody = `<p>测试模式: ${type === 'baseline' ? '基准测定' : '雾视挑战'}</p><p>视标级别: ${level || '-'}</p><p>最终得分: <strong>${correct} / ${total}</strong></p><p>准确率: <strong>${accuracy}%</strong></p>`;
                }
                document.getElementById('modal-body').innerHTML = customBody;

                document.getElementById('modal-btn-continue').style.display = 'none';
                
                const btnEnd = document.getElementById('modal-btn-end');
                btnEnd.textContent = '查看历史';
                btnEnd.className = 'btn bg-blue';
                btnEnd.onclick = () => endTestAndSave();

                document.getElementById('modal-btn-exit').onclick = () => {
                    saveTestRecord();
                    window.location.href = "better_vision.html"; 
                };
		
                setTimeout(() => { focusElementInCurrentView(0); }, 300); // 增加延迟
            }

            function showMenu(title = "已暂停", customBody = null) {
                if (appState.timerInterval) clearInterval(appState.timerInterval);
                if (appState.testState.status === 'running') appState.testState.status = 'paused';

                resultModal.style.display = 'flex';
                appState.currentView = 'result-modal'; // 更新当前视图状态
                document.getElementById('modal-title').textContent = title;
                
                const { correct, total, type } = appState.testState;
                const config = appState.testConfig;
                const level = type === 'baseline' ? config?.level?.decimal : config?.minLevel?.decimal;

                if (customBody) {
                    document.getElementById('modal-body').innerHTML = customBody;
                } else {
                    document.getElementById('modal-body').innerHTML = `<p>当前模式: ${type === 'baseline' ? '基准测试' : '雾视挑战'}</p><p>当前视标: ${level || '-'}</p><p>当前得分: <strong>${correct} / ${total}</strong></p>`;
                }
                
                const btnEnd = document.getElementById('modal-btn-end');
                btnEnd.textContent = '结束';
                btnEnd.className = 'btn bg-red';
                btnEnd.onclick = () => {
                    saveTestRecord();
                    window.location.href = 'history.html';
                };

                const btnContinue = document.getElementById('modal-btn-continue');
                btnContinue.style.display = 'inline-block';
                btnContinue.onclick = resumeTest;

                document.getElementById('modal-btn-exit').onclick = () => {
                    window.location.href = "better_vision.html"; 
                };
		
                // 暂停菜单时，统一使用 focusElementInCurrentView(0) 来聚焦第一个可见按钮
                // 增加延迟，确保电视端元素渲染并可聚焦
                setTimeout(() => { 
                    focusElementInCurrentView(0); 
                }, 300); // 将延迟从 200ms 增加到 300ms
            }

            function saveTestRecord() {
                const state = appState.testState;
                if (state.total > 0 || state.type === 'baseline') { 
                    let history = JSON.parse(localStorage.getItem('visionHistory') || '[]');
                    const newRecord = { date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), type: state.type === 'baseline' ? '测定基准' : '雾视挑战', level: appState.testConfig?.level?.decimal || appState.testConfig?.minLevel?.decimal, accuracy: state.total > 0 ? (state.correct / state.total) * 100 : 0, score: `${state.correct}/${state.total}` };
                    history.unshift(newRecord);
                    try {
                        localStorage.setItem('visionHistory', JSON.stringify(history));
                    } catch (e) { console.error(e); }
                }
            }

            function resumeTest() {
                resultModal.style.display = 'none';
                appState.testState.status = 'running';
                appState.currentView = 'page-test'; // 更新当前视图状态
                document.body.focus(); // 确保 body 重新获得焦点以捕获按键
                if (appState.testState.type === 'fogging' && appState.testState.timer > 0) {
                    startTimer();
                }
                // 恢复时，如果不是移动设备，则隐藏虚拟按键
                if (!isMobileDevice()) {
                    mobileControlsPanel.style.display = 'none';
                }
            }

            function endTestAndSave() {
                saveTestRecord();
                appState.testState.status = 'idle';
                window.location.href = 'history.html';
            }

            function updateTestUI() {
                const { timer, correct, total, currentE, type } = appState.testState;
                const config = appState.testConfig;
                document.getElementById('test-title').textContent = `${type === 'baseline' ? '基准测定' : '雾视挑战'} - ${config?.level?.decimal || config?.minLevel?.decimal || ''}`;
                testTimerEl.textContent = timer;
                testScoreEl.textContent = `${correct}/${total}`;
                if (currentE) renderEChart(currentE.level.sizePx, currentE.direction);
            }

            // --- 焦点管理函数 ---
            function getFocusablePreTestElements() {
                return Array.from(document.querySelectorAll('#pre-test-config .config-panel button')).filter(btn => btn.style.display !== 'none');
            }

            function getFocusableModalElements() {
                return Array.from(document.querySelectorAll('#modal-actions button')).filter(btn => btn.style.display !== 'none');
            }

            function focusElementInCurrentView(index) {
                let elements;
                if (appState.currentView === 'pre-test-config') {
                    elements = getFocusablePreTestElements();
                } else if (appState.currentView === 'result-modal') {
                    elements = getFocusableModalElements();
                } else {
                    return; // No specific focusable elements for 'page-test' in this context
                }

                if (elements.length === 0) {
                    console.warn(`No focusable elements found for view: ${appState.currentView}`);
                    return;
                }
                const newIndex = (index + elements.length) % elements.length;
                elements[newIndex].focus();
            }

            // --- 事件监听器 ---
            document.getElementById('mobile-btn-menu').onclick = () => showMenu();
            document.querySelectorAll('.touch-btn').forEach(btn => {
                btn.onclick = () => handleAnswer(btn.dataset.dir);
            });

            // 主题按钮事件监听 (在预测试配置界面)
            themeButtons.forEach(btn => {
                btn.onclick = () => applyTheme(btn.dataset.theme);
            });

            // "开始测试" 按钮事件监听
            startTestFromConfigBtn.onclick = () => {
                preTestConfigDiv.style.display = 'none';
                pageTestDiv.style.display = 'flex';
                
                // 根据设备类型决定是否显示移动端控制面板
                if (isMobileDevice()) {
                    mobileControlsPanel.style.display = 'flex'; 
                } else {
                    mobileControlsPanel.style.display = 'none';
                }

                appState.currentView = 'page-test'; // 更新当前视图状态
                document.body.focus(); // 确保测试界面获得焦点
                
                const storedConfig = localStorage.getItem('testConfig');
                if (storedConfig) {
                    try {
                        const config = JSON.parse(storedConfig);
                        startTest(config);
                    } catch (e) {
                        console.error("Config parse error", e);
                        window.location.href = 'better_vision.html';
                    }
                } else {
                    window.location.href = 'better_vision.html';
                }
            };

            // --- 遥控器监听 ---
            function handleRemoteControl(key, keyCode, event) {
                // !!! 在这里添加 console.log 进行调试 !!!
                console.log('Key pressed:', key, 'KeyCode:', keyCode);
                // !!! --------------------------------- !!!

                // 根据您的遥控器实际输出，可能需要修改以下数组，添加您遥控器“确定”键的 key 和 keyCode
                const isConfirmKey = ['Enter', ' ', 'OK', 'Select', 'Accept'].includes(key) || [13, 23, 66, 108].includes(keyCode);
                const isBackKey = ['Backspace', 'Escape', 'Back'].includes(key) || keyCode === 8 || keyCode === 27;

                if (event) event.preventDefault(); // 阻止默认滚动等行为

                // 优先级 1: 预测试配置界面
                if (appState.currentView === 'pre-test-config') {
                    const focusableElements = getFocusablePreTestElements();
                    let currentIndex = focusableElements.indexOf(document.activeElement);

                    if (isConfirmKey && document.activeElement && document.activeElement.closest('#pre-test-config')) {
                        document.activeElement.click();
                        return;
                    }
                    if (isBackKey) {
                        window.location.href = 'better_vision.html'; // 返回主菜单
                        return;
                    }
                    if (['ArrowUp', 'ArrowLeft', 'ArrowDown', 'ArrowRight'].includes(key)) {
                        let newIndex = currentIndex;
                        if (key === 'ArrowUp' || key === 'ArrowLeft') {
                            newIndex = (currentIndex - 1 + focusableElements.length) % focusableElements.length;
                        } else { // ArrowDown or ArrowRight
                            newIndex = (currentIndex + 1) % focusableElements.length;
                        }
                        focusElementInCurrentView(newIndex);
                        return;
                    }
                    return;
                }

                // 优先级 2: 暂停/结果菜单已打开
                if (appState.currentView === 'result-modal') {
                    const focusableElements = getFocusableModalElements();
                    let currentIndex = focusableElements.indexOf(document.activeElement);

                    if (isConfirmKey && document.activeElement && document.activeElement.closest('#result-modal')) {
                        document.activeElement.click();
                        return;
                    }
                    if (isBackKey) {
                        const continueBtn = document.getElementById('modal-btn-continue');
                        if (continueBtn.style.display !== 'none') {
                            continueBtn.click();
                        } else {
                            const exitBtn = document.getElementById('modal-btn-exit');
                            const endBtn = document.getElementById('modal-btn-end');
                            if (exitBtn) exitBtn.click();
                            else if (endBtn) endBtn.click(); 
                        }
                        return;
                    }
                    if (['ArrowUp', 'ArrowLeft', 'ArrowDown', 'ArrowRight'].includes(key)) {
                        let newIndex = currentIndex;
                        // 模态框按钮通常是水平排列的，所以左右键切换，上下键也按左右处理
                        if (key === 'ArrowUp' || key === 'ArrowLeft') {
                            newIndex = (currentIndex - 1 + focusableElements.length) % focusableElements.length;
                        } else { // ArrowDown or ArrowRight
                            newIndex = (currentIndex + 1) % focusableElements.length;
                        }
                        focusElementInCurrentView(newIndex);
                        return;
                    }
                    return;
                }

                // 优先级 3: 正常测试中 (appState.currentView === 'page-test')
                if (isConfirmKey) {
                    showMenu(); // 按确认键暂停
                    return;
                }

                if (KEY_MAP[key]) {
                    handleAnswer(KEY_MAP[key]); // 处理方向键答案
                }
            }

            window.addEventListener('keydown', (e) => {
                const keyCode = e.keyCode || e.which;
                handleRemoteControl(e.key, keyCode, e);
            });

            // --- 初始化 ---
            function initialize() {
                // 应用存储的主题到预测试界面
                applyTheme(currentTheme); 
                
                // 默认显示预测试配置界面
                preTestConfigDiv.style.display = 'flex';
                pageTestDiv.style.display = 'none';
                mobileControlsPanel.style.display = 'none'; // 初始隐藏移动端控制面板

                // 聚焦到预测试配置界面的第一个可聚焦元素 (通常是第一个主题按钮)
                setTimeout(() => { focusElementInCurrentView(0); }, 300); // 增加延迟
            }

            initialize();
        });
    </script>
    
</body>
</html>
