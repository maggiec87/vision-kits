<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>视力测试中</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* 针对移动端中心按钮的内联样式补充 */
        #mobile-btn-menu {
            display: flex;
            flex-direction: column; /* 图标在上，文字在下 */
            justify-content: center;
            align-items: center;
            padding: 0;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }
        #mobile-btn-menu svg {
            width: 24px; 
            height: 24px;
            margin-bottom: 2px;
        }
        #mobile-btn-menu span {
            font-size: 12px;
            line-height: 1;
            font-weight: bold;
        }
        /* 调整方向键容器间隙 */
        .directional-pad-container {
            gap: 8px; 
        }
    </style>
</head>
<body>
    <!-- SVG 图标定义文件 -->
    <div style="display: none;">
        <object type="image/svg+xml" data="icons.svg"></object>
    </div>

    <!-- 测试页 -->
    <div id="page-test" class="page">
        <header class="test-header">
            <div id="test-title" class="test-title"></div>
            <div class="test-info">
                <div id="timer-display"><span>计时:</span> <span id="test-timer">0</span>s</div>
                <div><span>得分:</span> <span id="test-score">0/0</span></div>
            </div>
        </header>
        <main class="test-main">
            <div id="e-chart-container">
                <svg id="e-chart-svg" viewBox="0 0 5 5">
                    <path d="M0,0 H5 V1 H1 V2 H5 V3 H1 V4 H5 V5 H0 Z" fill="currentColor"/>
                </svg>
            </div>
        </main>
        
        <!-- === 移动端专属控制面板 === -->
        <div class="mobile-controls-panel">
            <div class="directional-pad-container">
                <!-- 上 -->
                <button class="mobile-control-btn touch-btn btn-dir-up" data-dir="up">
                    <svg><use href="icons.svg#icon-up"/></svg>
                </button>
                
                <!-- 左 -->
                <button class="mobile-control-btn touch-btn btn-dir-left" data-dir="left">
                    <svg><use href="icons.svg#icon-left"/></svg>
                </button>
                
                <!-- 中间：暂停/菜单键 (黄色小块) -->
                <button id="mobile-btn-menu" class="mobile-control-btn bg-yellow" style="grid-area: 2 / 2 / 3 / 3;">
                    <svg><use href="icons.svg#icon-menu"/></svg>
                    <span>暂停</span>
                </button>
                
                <!-- 右 -->
                <button class="mobile-control-btn touch-btn btn-dir-right" data-dir="right">
                    <svg><use href="icons.svg#icon-right"/></svg>
                </button>
                
                <!-- 下 -->
                <button class="mobile-control-btn touch-btn btn-dir-down" data-dir="down">
                    <svg><use href="icons.svg#icon-down"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 菜单/结果弹窗 -->
    <div id="result-modal" style="display: none;">
        <div class="modal-content">
            <h2 id="modal-title">已暂停</h2>
            <div id="modal-body"></div>
            <div id="modal-actions" class="modal-actions">
                <button id="modal-btn-end" class="btn bg-red">结束</button>
                <button id="modal-btn-continue" class="btn bg-blue">继续</button>
                <button id="modal-btn-exit" class="btn bg-gray">退出</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 数据和常量 ---
            const PIXELS_PER_MM_ASSUMED = 96 / 25.4;
            const VISION_LEVELS = [
              { logMAR: '4.0', decimal: 0.1, sizeMm: 72.72 }, { logMAR: '4.1', decimal: 0.12, sizeMm: 60.60 },
              { logMAR: '4.2', decimal: 0.15, sizeMm: 48.48 }, { logMAR: '4.3', decimal: 0.2, sizeMm: 36.36 },
              { logMAR: '4.4', decimal: 0.25, sizeMm: 29.09 }, { logMAR: '4.5', decimal: 0.3, sizeMm: 24.24 },
              { logMAR: '4.6', decimal: 0.4, sizeMm: 18.18 }, { logMAR: '4.7', decimal: 0.5, sizeMm: 14.54 },
              { logMAR: '4.8', decimal: 0.6, sizeMm: 12.12 }, { logMAR: '4.9', decimal: 0.8, sizeMm: 9.09 },
              { logMAR: '5.0', decimal: 1.0, sizeMm: 7.27 }, { logMAR: '5.1', decimal: 1.2, sizeMm: 6.06 },
              { logMAR: '5.2', decimal: 1.5, sizeMm: 4.85 }, { logMAR: '5.3', decimal: 2.0, sizeMm: 3.64 },
            ].map(level => ({
                ...level,
                sizePx: (level.sizeMm * PIXELS_PER_MM_ASSUMED) / 4
            }));
            const DIRECTIONS = ['up', 'down', 'left', 'right'];
            const KEY_MAP = { ArrowUp: 'up', ArrowDown: 'down', ArrowLeft: 'left', ArrowRight: 'right' };
            const ROTATION_MAP = { up: -90, down: 90, left: 180, right: 0 };

            // --- 应用状态 ---
            let appState = {
                testConfig: null,
                testState: {
                    status: 'idle', timer: 0, correct: 0, total: 0, currentE: null, type: null,
                },
                timerInterval: null,
            };

            // --- DOM 元素引用 ---
            const eChartEl = document.getElementById('e-chart-svg');
            const testTimerEl = document.getElementById('test-timer');
            const testScoreEl = document.getElementById('test-score');
            const resultModal = document.getElementById('result-modal');
            const timerDisplay = document.getElementById('timer-display');
            
            // --- 核心功能函数 ---
            function renderEChart(sizePx, direction) {
                eChartEl.style.width = `${sizePx}px`;
                eChartEl.style.height = `${sizePx}px`;
                eChartEl.style.transform = `rotate(${ROTATION_MAP[direction]}deg)`;
            }

            function generateRandomE(level) {
                const randomDirection = DIRECTIONS[Math.floor(Math.random() * DIRECTIONS.length)];
                return { level, direction: randomDirection };
            }

            function startTest(config) {
                appState.testConfig = config;
                let initialE;
                if (config.type === 'baseline') {
                    initialE = generateRandomE(config.level);
                    timerDisplay.style.display = 'none'; 
                } else { 
                    const levels = [...config.fogLevels, config.minLevel];
                    const randomLevel = levels[Math.floor(Math.random() * levels.length)];
                    initialE = generateRandomE(randomLevel);
                    timerDisplay.style.display = 'block';
                }
                
                const initialTimer = config.type === 'baseline' ? 0 : 60;

                appState.testState = { status: 'running', timer: initialTimer, correct: 0, total: 0, currentE: initialE, type: config.type };
                updateTestUI();
                
                if (config.type === 'fogging') {
                    startTimer();
                }
            }
            
            function startTimer() {
                if (appState.timerInterval) clearInterval(appState.timerInterval);
                appState.timerInterval = setInterval(() => {
                    if (appState.testState.status !== 'running') return;
                    
                    appState.testState.timer--;
                    testTimerEl.textContent = appState.testState.timer;
                    
                    // === 修改点：时间结束逻辑 ===
                    if (appState.testState.timer <= 0) {
                        clearInterval(appState.timerInterval); // 停止计时器
                        appState.testState.status = 'paused';  // 暂停状态
                        
                        // 弹出菜单，isFinished = false (保留继续按钮)
                        showMenu('挑战时间结束', null, false);
                    }
                }, 1000);
            }

            function handleAnswer(answer) {
                if (appState.testState.status !== 'running') return;
                const state = appState.testState;
                const config = appState.testConfig;
                
                state.correct += (answer === state.currentE.direction ? 1 : 0);
                state.total += 1;

                if (state.type === 'baseline' && state.total >= 10) {
                    updateTestUI();
                    evaluateBaselineResult();
                    return;
                }

                let nextE;
                if (state.type === 'baseline') {
                    nextE = generateRandomE(config.level);
                } else {
                    const isNextMinLevel = (state.total + 1) % 2 !== 0;
                    const levelToUse = isNextMinLevel ? config.minLevel : config.fogLevels[Math.floor(Math.random() * config.fogLevels.length)];
                    nextE = generateRandomE(levelToUse);
                }
                state.currentE = nextE;
                updateTestUI();
            }

            function evaluateBaselineResult() {
                clearInterval(appState.timerInterval);
                appState.testState.status = 'paused';
                
                const { correct } = appState.testState;
                let title = "基准测试完成";
                let message = `<p>得分: <strong>${correct}/10</strong></p>`;
                
                if (correct >= 8) {
                    message += `<p class="eval-text text-green">✔ 视标合适</p><p>准确率达标，可进行雾视挑战</p>`;
                } else if (correct <= 6) {
                    message += `<p class="eval-text text-red">✘ 建议换大一级</p><p>准确率过低，请调整视标重测。</p>`;
                } else {
                    message += `<p class="eval-text text-yellow">⚠ 建议重测</p><p>处于临界值，建议再测一次。</p>`;
                }

                // 基准测试完成是真正的结束，isFinished = true (隐藏继续按钮)
                showMenu(title, message, true);
            }

            // --- 菜单/模态框逻辑 ---
            function focusMenuButton(index) {
                const buttons = document.querySelectorAll('#modal-actions button');
                const visibleButtons = Array.from(buttons).filter(btn => btn.style.display !== 'none');
                if (visibleButtons.length === 0) return;
                if (index < 0) index = visibleButtons.length - 1;
                if (index >= visibleButtons.length) index = 0;
                visibleButtons[index].focus();
            }

            function showMenu(title = "已暂停", customBody = null, isFinished = false) {
                if (appState.timerInterval) clearInterval(appState.timerInterval);
                if (appState.testState.status === 'running') appState.testState.status = 'paused';

                resultModal.style.display = 'flex';
                document.getElementById('modal-title').textContent = title;
                
                const { correct, total, type } = appState.testState;
                const config = appState.testConfig;
                const level = type === 'baseline' ? config?.level?.decimal : config?.minLevel?.decimal;

                if (customBody) {
                    document.getElementById('modal-body').innerHTML = customBody;
                } else {
                    document.getElementById('modal-body').innerHTML = `
                        <p>当前模式: ${type === 'baseline' ? '基准测试' : '雾视挑战'}</p>
                        <p>当前视标: ${level || '-'}</p>
                        <p>当前得分: <strong>${correct} / ${total}</strong></p>
                    `;
                }

                const btnContinue = document.getElementById('modal-btn-continue');
                if (isFinished) {
                    btnContinue.style.display = 'none';
                } else {
                    btnContinue.style.display = 'inline-block';
                    btnContinue.onclick = resumeTest;
                }

                document.getElementById('modal-btn-end').onclick = () => endTestAndSave();
                document.getElementById('modal-btn-exit').onclick = () => {
                    window.location.href = "index.html"; 
                };

                setTimeout(() => {
                    const buttons = Array.from(document.querySelectorAll('#modal-actions button')).filter(b => b.style.display !== 'none');
                    const continueBtnIndex = buttons.indexOf(btnContinue);
                    if (continueBtnIndex !== -1) {
                        focusMenuButton(continueBtnIndex);
                    } else {
                        focusMenuButton(0);
                    }
                }, 100);
            }

            function resumeTest() {
                resultModal.style.display = 'none';
                appState.testState.status = 'running';
                
                // === 修改点：继续逻辑 ===
                // 只有当时间还有剩余时，才重新启动倒计时
                // 如果时间已耗尽(<=0)，用户点击继续则进入"自由练习模式"，不再倒计时
                if (appState.testState.type === 'fogging' && appState.testState.timer > 0) {
                    startTimer();
                }
            }

            function endTestAndSave() {
                resultModal.style.display = 'none';
                const state = appState.testState;
                if (state.total > 0 || state.type === 'baseline') { 
                    let history = JSON.parse(localStorage.getItem('visionHistory') || '[]');
                    const newRecord = { 
                        date: new Date().toLocaleDateString(), 
                        time: new Date().toLocaleTimeString(), 
                        type: state.type === 'baseline' ? '测定基准' : '雾视挑战', 
                        level: appState.testConfig?.level?.decimal || appState.testConfig?.minLevel?.decimal, 
                        accuracy: state.total > 0 ? (state.correct / state.total) * 100 : 0, 
                        score: `${state.correct}/${state.total}` 
                    };
                    history.unshift(newRecord);
                    try {
                        localStorage.setItem('visionHistory', JSON.stringify(history));
                    } catch (e) { console.error(e); }
                }
                appState.testState.status = 'idle';
                window.location.href = 'history.html';
            }

            function updateTestUI() {
                const { timer, correct, total, currentE, type } = appState.testState;
                const config = appState.testConfig;
                document.getElementById('test-title').textContent = `${type === 'baseline' ? '基准测定' : '雾视挑战'} - ${config?.level?.decimal || config?.minLevel?.decimal || ''}`;
                testTimerEl.textContent = timer;
                testScoreEl.textContent = `${correct}/${total}`;
                if (currentE) renderEChart(currentE.level.sizePx, currentE.direction);
            }

            // --- 事件监听器 ---
            document.getElementById('mobile-btn-menu').onclick = () => showMenu();
            document.querySelectorAll('.touch-btn').forEach(btn => {
                btn.onclick = () => handleAnswer(btn.dataset.dir);
            });

            // --- 键盘/遥控器监听 ---
            window.addEventListener('keydown', (e) => {
                const keyCode = e.keyCode || e.which;
                const isMenuOpen = resultModal.style.display === 'flex';
                
                // 兼容性修复：包含 13(PC/标准), 23(Android TV), 108(部分其他)
                const isConfirmKey = (
                    e.key === 'Enter' || e.key === ' ' || e.key === 'OK' || 
                    e.key === 'Select' || e.key === 'Accept' ||
                    keyCode === 13 || keyCode === 23 || keyCode === 108
                );

                if (isConfirmKey) {
                    e.preventDefault(); 
                    
                    if (isMenuOpen) {
                        if (document.activeElement && document.activeElement.tagName === 'BUTTON') {
                            document.activeElement.click();
                        } else {
                            const btnContinue = document.getElementById('modal-btn-continue');
                            if (btnContinue.style.display !== 'none') {
                                btnContinue.click();
                            } else {
                                const firstBtn = document.querySelector('#modal-actions button:not([style*="display: none"])');
                                if (firstBtn) firstBtn.click();
                            }
                        }
                    } else {
                        showMenu();
                    }
                    return;
                }

                if (isMenuOpen) {
                    const buttons = Array.from(document.querySelectorAll('#modal-actions button')).filter(b => b.style.display !== 'none');
                    let currentIndex = buttons.indexOf(document.activeElement);
                    
                    if (['ArrowUp', 'ArrowLeft', 'ArrowDown', 'ArrowRight'].includes(e.key) || KEY_MAP[e.key]) {
                        e.preventDefault();
                        if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                            focusMenuButton(currentIndex - 1);
                        } else if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
                            focusMenuButton(currentIndex + 1);
                        }
                    }
                    return;
                }

                if (KEY_MAP[e.key]) {
                    e.preventDefault();
                    handleAnswer(KEY_MAP[e.key]);
                }
            });

            // --- 初始化 ---
            function initialize() {
                const storedConfig = localStorage.getItem('testConfig');
                if (storedConfig) {
                    try {
                        const config = JSON.parse(storedConfig);
                        startTest(config);
                    } catch (e) {
                        console.error("Config parse error", e);
                        window.location.href = 'index.html';
                    }
                } else {
                    window.location.href = 'index.html';
                }
            }

            initialize();
        });
    </script>
</body>
</html>
