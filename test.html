<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>视力测试中</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* 针对移动端中心按钮的内联样式补充 */
        #mobile-btn-menu {
            display: block;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }
        #mobile-btn-menu svg {
            width: 24px; 
            height: 24px;
            margin-bottom: 2px;
        }
        #mobile-btn-menu span {
            font-size: 12px;
            line-height: 1;
            font-weight: bold;
        }
        .directional-pad-container {
            gap: 8px; 
        }
        /* 电视兼容性：确保模态框层级最高且可见 */
        #result-modal {
            z-index: 9999;
        }
        /* 电视兼容性：为获得焦点的按钮添加明显样式 */
         button:focus {
            outline: 30px solid #FFD700 /* 金色边框 */
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
        } 
        /* 历史记录样式 */
        .eval-text {
            font-weight: bold;
            margin: 10px 0;
        }
        .text-green { color: #4CAF50; }
        .text-red { color: #f44336; }
        .text-yellow { color: #FF9800; }
    </style>
</head>
<!-- 添加 tabindex="0" 让 body 可聚焦，捕获电视按键 -->
<body tabindex="0">
    <!-- SVG 图标定义文件 -->
    <div style="display: none;">
        <object type="image/svg+xml" data="icons.svg"></object>
    </div>

    <!-- 测试页 -->
    <div id="page-test" class="page">
        <header class="test-header">
            <div id="test-title" class="test-title"></div>
            <div class="test-info">
                <div id="timer-display"><span>计时:</span> <span id="test-timer">0</span>s</div>
                <div><span>得分:</span> <span id="test-score">0/0</span></div>
            </div>
        </header>
        <main class="test-main">
            <div id="e-chart-container">
                <svg id="e-chart-svg" viewBox="0 0 5 5">
                    <path d="M0,0 H5 V1 H1 V2 H5 V3 H1 V4 H5 V5 H0 Z" fill="currentColor"/>
                </svg>
            </div>
        </main>
        
        <!-- === 移动端专属控制面板 === -->
        <div class="mobile-controls-panel">
            <div class="directional-pad-container">
                <button class="mobile-control-btn touch-btn btn-dir-up" data-dir="up"><svg><use href="icons.svg#icon-up"/></svg></button>
                <button class="mobile-control-btn touch-btn btn-dir-left" data-dir="left"><svg><use href="icons.svg#icon-left"/></svg></button>
                <button id="mobile-btn-menu" class="mobile-control-btn bg-yellow" style="grid-area: 2 / 2 / 3 / 3;">
                    <svg><use href="icons.svg#icon-menu"/></svg>
                    <span>暂停</span>
                </button>
                <button class="mobile-control-btn touch-btn btn-dir-right" data-dir="right"><svg><use href="icons.svg#icon-right"/></svg></button>
                <button class="mobile-control-btn touch-btn btn-dir-down" data-dir="down"><svg><use href="icons.svg#icon-down"/></svg></button>
            </div>
        </div>
    </div>

    <!-- 菜单/结果弹窗 -->
    <div id="result-modal" style="display: none;">
        <div class="modal-content">
            <h2 id="modal-title">已暂停</h2>
            <div id="modal-body"></div>
            <div id="modal-actions" class="modal-actions">
                <button id="modal-btn-end" class="btn bg-red">结束</button>
                <button id="modal-btn-continue" class="btn bg-blue">继续</button>
                <button id="modal-btn-exit" class="btn bg-gray">退出</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 电视焦点初始化 ---
            document.body.focus();

            // --- 数据和常量 ---
            const PIXELS_PER_MM_ASSUMED = 96 / 25.4;
            const DIRECTIONS = ['up', 'down', 'left', 'right'];
            const KEY_MAP = { ArrowUp: 'up', ArrowDown: 'down', ArrowLeft: 'left', ArrowRight: 'right' };
            const ROTATION_MAP = { up: -90, down: 90, left: 180, right: 0 };

            // --- 应用状态 ---
            let appState = {
                testConfig: null,
                testState: { status: 'idle', timer: 0, correct: 0, total: 0, currentE: null, type: null },
                timerInterval: null,
            };

            // --- DOM 元素引用 ---
            const eChartEl = document.getElementById('e-chart-svg');
            const testTimerEl = document.getElementById('test-timer');
            const testScoreEl = document.getElementById('test-score');
            const resultModal = document.getElementById('result-modal');
            const timerDisplay = document.getElementById('timer-display');
            
            // --- 核心功能函数 ---
            function renderEChart(sizePx, direction) {
                eChartEl.style.width = `${sizePx}px`;
                eChartEl.style.height = `${sizePx}px`;
                eChartEl.style.transform = `rotate(${ROTATION_MAP[direction]}deg)`;
            }

            function generateRandomE(level) {
                const randomDirection = DIRECTIONS[Math.floor(Math.random() * DIRECTIONS.length)];
                return { level, direction: randomDirection };
            }

            function startTest(config) {
                appState.testConfig = config;
                let initialE;
                if (config.type === 'baseline') {
                    initialE = generateRandomE(config.level);
                    timerDisplay.style.display = 'none'; 
                } else { 
                    const levels = [...config.fogLevels, config.minLevel];
                    const randomLevel = levels[Math.floor(Math.random() * levels.length)];
                    initialE = generateRandomE(randomLevel);
                    timerDisplay.style.display = 'block';
                }
                
                const initialTimer = config.type === 'baseline' ? 0 : 60;

                appState.testState = { status: 'running', timer: initialTimer, correct: 0, total: 0, currentE: initialE, type: config.type };
                updateTestUI();
                
                if (config.type === 'fogging') {
                    startTimer();
                }
            }
            
            function startTimer() {
                if (appState.timerInterval) clearInterval(appState.timerInterval);
                appState.timerInterval = setInterval(() => {
                    if (appState.testState.status !== 'running') return;
                    
                    appState.testState.timer--;
                    testTimerEl.textContent = appState.testState.timer;
                    
                    // === 自动结束逻辑 ===
                    if (appState.testState.timer <= 0) {
                        clearInterval(appState.timerInterval);
                        appState.testState.status = 'paused';
                        
                        // 雾视挑战结束，显示最终结果
                        console.log("Timer ended, showing final result"); 
                        showFinalResult();
                    }
                }, 1000);
            }

            function handleAnswer(answer) {
                if (appState.testState.status !== 'running') return;
                const state = appState.testState;
                const config = appState.testConfig;
                
                state.correct += (answer === state.currentE.direction ? 1 : 0);
                state.total += 1;

                if (state.type === 'baseline' && state.total >= 10) {
                    updateTestUI();
                    evaluateBaselineResult();
                    return;
                }

                let nextE;
                if (state.type === 'baseline') {
                    nextE = generateRandomE(config.level);
                } else {
                    const isNextMinLevel = (state.total + 1) % 2 !== 0;
                    const levelToUse = isNextMinLevel ? config.minLevel : config.fogLevels[Math.floor(Math.random() * config.fogLevels.length)];
                    nextE = generateRandomE(levelToUse);
                }
                state.currentE = nextE;
                updateTestUI();
            }

            function evaluateBaselineResult() {
                clearInterval(appState.timerInterval);
                appState.testState.status = 'paused';
                
                const { correct } = appState.testState;
                let title = "基准测试完成";
                let message = `<p>得分: <strong>${correct}/10</strong></p>`;
                
                if (correct >= 8) {
                    message += `<p class="eval-text text-green">✔ 视标合适</p><p>准确率达标，可进行雾视挑战</p>`;
                } else if (correct <= 6) {
                    message += `<p class="eval-text text-red">✘ 建议换大一级</p><p>准确率过低，请调整视标重测。</p>`;
                } else {
                    message += `<p class="eval-text text-yellow">⚠ 建议重测</p><p>处于临界值，建议再测一次。</p>`;
                }

                // 基准测试结束，只显示查看历史和退出
                showFinalResult(title, message);
            }

            // === 新增：显示最终结果的函数 ===
            function showFinalResult(title = null, customBody = null) {
                clearInterval(appState.timerInterval);
                appState.testState.status = 'paused';

                resultModal.style.display = 'block';
                
                const { correct, total, type } = appState.testState;
                const config = appState.testConfig;
                const level = type === 'baseline' ? config?.level?.decimal : config?.minLevel?.decimal;

                // 设置标题
                if (!title) {
                    title = type === 'baseline' ? '基准测试完成' : '雾视挑战完成';
                }
                document.getElementById('modal-title').textContent = title;

                // 设置内容
                if (!customBody) {
                    const accuracy = total > 0 ? ((correct / total) * 100).toFixed(1) : 0;
                    customBody = `
                        <p>测试模式: ${type === 'baseline' ? '基准测定' : '雾视挑战'}</p>
                        <p>视标级别: ${level || '-'}</p>
                        <p>最终得分: <strong>${correct} / ${total}</strong></p>
                        <p>准确率: <strong>${accuracy}%</strong></p>
                    `;
                }
                document.getElementById('modal-body').innerHTML = customBody;

                // 隐藏"继续"按钮，只显示"查看历史"和"退出"
                document.getElementById('modal-btn-continue').style.display = 'none';
                
                // 修改"结束"按钮为"查看历史"
                const btnEnd = document.getElementById('modal-btn-end');
                btnEnd.textContent = '查看历史';
                btnEnd.className = 'btn bg-blue'; // 改为蓝色
                btnEnd.onclick = () => endTestAndSave();

                // 保持"退出"按钮链接到 better_vision.html
                document.getElementById('modal-btn-exit').onclick = () => {
                    // 先保存记录再退出
                    saveTestRecord();
                    window.location.href = "better_vision.html"; 
                };

                // 延迟聚焦，确保DOM渲染完成
		/*
                setTimeout(() => {
                    focusMenuButton(0); // 默认聚焦第一个按钮（查看历史）
                }, 200);
		*/
		
            }

            // === 修改：菜单显示函数（用于暂停） ===
            function showMenu(title = "已暂停", customBody = null, isFinished = false) {
                if (appState.timerInterval) clearInterval(appState.timerInterval);
                if (appState.testState.status === 'running') appState.testState.status = 'paused';

                resultModal.style.display = 'block';
                document.getElementById('modal-title').textContent = title;
                
                const { correct, total, type } = appState.testState;
                const config = appState.testConfig;
                const level = type === 'baseline' ? config?.level?.decimal : config?.minLevel?.decimal;

                if (customBody) {
                    document.getElementById('modal-body').innerHTML = customBody;
                } else {
                    document.getElementById('modal-body').innerHTML = `
                        <p>当前模式: ${type === 'baseline' ? '基准测试' : '雾视挑战'}</p>
                        <p>当前视标: ${level || '-'}</p>
                        <p>当前得分: <strong>${correct} / ${total}</strong></p>
                    `;
                }

                // 恢复按钮文本和样式
                const btnEnd = document.getElementById('modal-btn-end');
                btnEnd.textContent = '结束';
                btnEnd.className = 'btn bg-red';
                btnEnd.onclick = () => {
                    saveTestRecord();
                    window.location.href = 'history.html';
                };

                const btnContinue = document.getElementById('modal-btn-continue');
                btnContinue.style.display = 'inline-block';
                btnContinue.onclick = resumeTest;

                document.getElementById('modal-btn-exit').onclick = () => {
                    window.location.href = "better_vision.html"; 
                };

                // 延迟聚焦
		/*
                setTimeout(() => {
                    focusMenuButton(1); // 默认聚焦"继续"按钮
                }, 200);
		*/
            }

            // === 新增：保存测试记录的函数 ===
            function saveTestRecord() {
                const state = appState.testState;
                if (state.total > 0 || state.type === 'baseline') { 
                    let history = JSON.parse(localStorage.getItem('visionHistory') || '[]');
                    const newRecord = { 
                        date: new Date().toLocaleDateString(), 
                        time: new Date().toLocaleTimeString(), 
                        type: state.type === 'baseline' ? '测定基准' : '雾视挑战', 
                        level: appState.testConfig?.level?.decimal || appState.testConfig?.minLevel?.decimal, 
                        accuracy: state.total > 0 ? (state.correct / state.total) * 100 : 0, 
                        score: `${state.correct}/${state.total}` 
                    };
                    history.unshift(newRecord);
                    try {
                        localStorage.setItem('visionHistory', JSON.stringify(history));
                    } catch (e) { console.error(e); }
                }
            }

            function resumeTest() {
                resultModal.style.display = 'none';
                appState.testState.status = 'running';
                
                // 恢复焦点到 body，以便继续接收方向键
                document.body.focus();

                if (appState.testState.type === 'fogging' && appState.testState.timer > 0) {
                    startTimer();
                }
            }

            function endTestAndSave() {
                saveTestRecord();
                appState.testState.status = 'idle';
                window.location.href = 'history.html';
            }

            function updateTestUI() {
                const { timer, correct, total, currentE, type } = appState.testState;
                const config = appState.testConfig;
                document.getElementById('test-title').textContent = `${type === 'baseline' ? '基准测定' : '雾视挑战'} - ${config?.level?.decimal || config?.minLevel?.decimal || ''}`;
                testTimerEl.textContent = timer;
                testScoreEl.textContent = `${correct}/${total}`;
                if (currentE) renderEChart(currentE.level.sizePx, currentE.direction);
            }

            // === 修改：焦点管理函数 ===
            function focusMenuButton(index) {
                const buttons = document.querySelectorAll('#modal-actions button');
                const visibleButtons = Array.from(buttons).filter(btn => btn.style.display !== 'none');
                if (visibleButtons.length === 0) return;
                
                // 确保索引在有效范围内（循环）
                if (index < 0) index = visibleButtons.length - 1;
                if (index >= visibleButtons.length) index = 0;
                
                visibleButtons[index].focus();
            }

            // --- 事件监听器 ---
            document.getElementById('mobile-btn-menu').onclick = () => showMenu();
            document.querySelectorAll('.touch-btn').forEach(btn => {
                btn.onclick = () => handleAnswer(btn.dataset.dir);
            });

            // === 修改：键盘/遥控器监听 ===
            function handleRemoteControl(key, keyCode, event) {
                const isMenuOpen = resultModal.style.display === 'block';
                
                // 确定键检测（支持多种遥控器）
                const isConfirmKey = (
                    key === 'Enter' || key === ' ' || key === 'OK' || 
                    key === 'Select' || key === 'Accept' ||
                    keyCode === 13 || keyCode === 23 || keyCode === 66 || keyCode === 108
                );

                if (isConfirmKey) {
                    if (event) event.preventDefault(); 
                    
                    if (isMenuOpen) {
                        // 如果菜单打开，触发当前聚焦按钮的点击
                        if (document.activeElement && document.activeElement.tagName === 'BUTTON') {
                            document.activeElement.click();
                        } else {
                            // 兜底：点击第一个可见按钮
                            const firstBtn = document.querySelector('#modal-actions button:not([style*="display: none"])');
                            if (firstBtn) firstBtn.click();
                        }
                    } else {
                        // 如果菜单没打开，打开暂停菜单
                        showMenu();
                    }
                    return;
                }

                // 菜单导航逻辑
                if (isMenuOpen) {
                    const buttons = Array.from(document.querySelectorAll('#modal-actions button')).filter(b => b.style.display !== 'none');
                    let currentIndex = buttons.indexOf(document.activeElement);
                    if (currentIndex === -1) currentIndex = 0; // 防止索引丢失
                    
                    if (['ArrowUp', 'ArrowLeft', 'ArrowDown', 'ArrowRight'].includes(key) || KEY_MAP[key]) {
                        if (event) event.preventDefault();
                        if (key === 'ArrowUp' || key === 'ArrowLeft') {
                            focusMenuButton(currentIndex - 1);
                        } else if (key === 'ArrowDown' || key === 'ArrowRight') {
                            focusMenuButton(currentIndex + 1);
                        }
                    }
                    return;
                }

                // 答题逻辑
                if (KEY_MAP[key]) {
                    if (event) event.preventDefault();
                    handleAnswer(KEY_MAP[key]);
                }
            }

            // 监听 keydown (主要)
            window.addEventListener('keydown', (e) => {
                const keyCode = e.keyCode || e.which;
                handleRemoteControl(e.key, keyCode, e);
            });

            // --- 初始化 ---
            function initialize() {
                const storedConfig = localStorage.getItem('testConfig');
                if (storedConfig) {
                    try {
                        const config = JSON.parse(storedConfig);
                        startTest(config);
                    } catch (e) {
                        console.error("Config parse error", e);
                        window.location.href = 'index.html';
                    }
                } else {
                    window.location.href = 'index.html';
                }
            }

            initialize();
        });
    </script>
</body>
</html>

