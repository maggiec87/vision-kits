<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>视力测试中</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* 针对移动端中心按钮的内联样式补充 */
        #mobile-btn-menu {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }
        #mobile-btn-menu svg {
            width: 24px; 
            height: 24px;
            margin-bottom: 2px;
        }
        #mobile-btn-menu span {
            font-size: 12px;
            line-height: 1;
            font-weight: bold;
        }
        .directional-pad-container {
            gap: 8px; 
        }
        
        /* --- 电视兼容性焦点样式 (已更新) --- */
        button:focus {
            outline: 3px solid #FFD700; /* 金色边框 */
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            z-index: 1001; /* 确保焦点在最上层 */
        }
        /* 为主题菜单中的按钮应用同样的焦点样式 */
        #theme-menu button:focus {
            outline: 3px solid #FFD700;
            transform: none; /* 菜单内按钮不需要缩放 */
            box-shadow: none;
            background-color: var(--color-bg-hover); /* 使用悬停背景色作为高亮 */
        }

        /* 历史记录样式 */
        .eval-text {
            font-weight: bold;
            margin: 10px 0;
        }
        .text-green { color: #4CAF50; }
        .text-red { color: #f44336; }
        .text-yellow { color: #FF9800; }
    </style>
</head>
<!-- 添加 tabindex="0" 让 body 可聚焦，捕获电视按键 -->
<body tabindex="0">
    <!-- SVG 图标定义文件 -->
    <div style="display: none;">
        <object type="image/svg+xml" data="icons.svg"></object>
    </div>

    <!-- 测试页 -->
    <div id="page-test" class="page">
        <header class="test-header">
            <div id="test-title" class="test-title"></div>
            <div class="test-info">
                <div id="timer-display"><span>计时:</span> <span id="test-timer">0</span>s</div>
                <div><span>得分:</span> <span id="test-score">0/0</span></div>
            </div>
        </header>
        <main class="test-main">
            <div id="e-chart-container">
                <svg id="e-chart-svg" viewBox="0 0 5 5">
                    <path d="M0,0 H5 V1 H1 V2 H5 V3 H1 V4 H5 V5 H0 Z" fill="currentColor"/>
                </svg>
            </div>
        </main>
        
        <!-- === 移动端专属控制面板 === -->
        <div class="mobile-controls-panel">
            <div class="directional-pad-container">
                <button class="mobile-control-btn touch-btn btn-dir-up" data-dir="up"><svg><use href="icons.svg#icon-up"/></svg></button>
                <button class="mobile-control-btn touch-btn btn-dir-left" data-dir="left"><svg><use href="icons.svg#icon-left"/></svg></button>
                <button id="mobile-btn-menu" class="mobile-control-btn bg-yellow" style="grid-area: 2 / 2 / 3 / 3;">
                    <svg><use href="icons.svg#icon-menu"/></svg>
                    <span>暂停</span>
                </button>
                <button class="mobile-control-btn touch-btn btn-dir-right" data-dir="right"><svg><use href="icons.svg#icon-right"/></svg></button>
                <button class="mobile-control-btn touch-btn btn-dir-down" data-dir="down"><svg><use href="icons.svg#icon-down"/></svg></button>
            </div>
        </div>
    </div>

    <!-- 菜单/结果弹窗 -->
    <div id="result-modal" style="display: none;">
        <div class="modal-content">
            <h2 id="modal-title">已暂停</h2>
            <div id="modal-body"></div>
            <div id="modal-actions" class="modal-actions">
                <button id="modal-btn-end" class="btn bg-red">结束</button>
                <button id="modal-btn-continue" class="btn bg-blue">继续</button>
                <button id="modal-btn-exit" class="btn bg-gray">退出</button>
            </div>
        </div>
    </div>


    <!-- ======================================================= -->
    <!-- ============== 主题切换器 (Theme Switcher) ============== -->
    <!-- ======================================================= -->
    <div id="theme-switcher">
        <!-- 主切换按钮 -->
        <button id="theme-toggle-btn" title="切换主题">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2.25a.75.75 0 01.75.75v.518a9.75 9.75 0 018.013 8.013h.518a.75.75 0 010 1.5h-.518a9.75 9.75 0 01-8.013 8.013v.518a.75.75 0 01-1.5 0v-.518a9.75 9.75 0 01-8.013-8.013H2.25a.75.75 0 010-1.5h.518A9.75 9.75 0 0110.768 3.518v-.518A.75.75 0 0112 2.25zM4.665 11.25a7.25 7.25 0 006.585 6.585 7.25 7.25 0 006.585-6.585 7.25 7.25 0 00-6.585-6.585 7.25 7.25 0 00-6.585 6.585zM12 8.25a3.75 3.75 0 110 7.5 3.75 3.75 0 010-7.5z" />
            </svg>
        </button>
        <!-- 主题选择菜单 (默认隐藏) -->
        <div id="theme-menu" class="hidden">
            <button data-theme="light">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a.75.75 0 01.75.75v.518a7.25 7.25 0 016.013 6.013h.518a.75.75 0 010 1.5h-.518a7.25 7.25 0 01-6.013 6.013v.518a.75.75 0 01-1.5 0v-.518A7.25 7.25 0 013.232 10.75h-.518a.75.75 0 010-1.5h.518A7.25 7.25 0 019.25 3.268v-.518A.75.75 0 0110 2zM8.5 10a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0z" clip-rule="evenodd" /></svg>
                <span>默认模式</span>
            </button>
            <button data-theme="dark">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7.455 2.104a.75.75 0 00-.91.093l-.292.313a.75.75 0 00.093.91l7.072 6.61-7.072 6.61a.75.75 0 00-.093.91l.292.313a.75.75 0 00.91.093l7.622-7.128a.75.75 0 000-1.002L7.455 2.104z" /></svg>
                <span>暗黑模式</span>
            </button>
            <button data-theme="paper">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.5 2.75a.75.75 0 00-1.5 0v14.5a.75.75 0 001.5 0v-4.392l1.657-.348a6.44 6.44 0 014.271.024l.143.048.143-.048a6.44 6.44 0 014.271-.024l1.657.348V2.75a.75.75 0 00-1.5 0v10.45l-1.224-.257a4.94 4.94 0 00-3.276-.02L8.5 13.207l-.223-.074a4.94 4.94 0 00-3.276.02L3.776 13.45v-10.7z" /></svg>
                <span>纸质模式</span>
            </button>
            <button data-theme="eyecare">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z" /><path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 010-1.18l.88-1.84a1.65 1.65 0 011.529-1.047h1.402a1.65 1.65 0 011.529 1.047l.88 1.84a1.651 1.651 0 010 1.18l-.88 1.84a1.65 1.65 0 01-1.529 1.047H3.073a1.65 1.65 0 01-1.529-1.047l-.88-1.84zM10 15a5 5 0 100-10 5 5 0 000 10z" clip-rule="evenodd" /></svg>
                <span>护眼模式</span>
            </button>
        </div>
    </div>


    <!-- 
        您的主脚本逻辑。
        请确保此处的 handleRemoteControl 函数已经更新，
        以支持对主题切换器的遥控器操作。
    -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 电视焦点初始化 ---
            document.body.focus();

            // --- 数据和常量 ---
            const DIRECTIONS = ['up', 'down', 'left', 'right'];
            const KEY_MAP = { ArrowUp: 'up', ArrowDown: 'down', ArrowLeft: 'left', ArrowRight: 'right' };
            const ROTATION_MAP = { up: -90, down: 90, left: 180, right: 0 };

            // --- 应用状态 ---
            let appState = {
                testConfig: null,
                testState: { status: 'idle', timer: 0, correct: 0, total: 0, currentE: null, type: null },
                timerInterval: null,
            };

            // --- DOM 元素引用 ---
            const eChartEl = document.getElementById('e-chart-svg');
            const testTimerEl = document.getElementById('test-timer');
            const testScoreEl = document.getElementById('test-score');
            const resultModal = document.getElementById('result-modal');
            const timerDisplay = document.getElementById('timer-display');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const themeMenu = document.getElementById('theme-menu');
            
            // --- 核心功能函数 ---
            function renderEChart(sizePx, direction) {
                eChartEl.style.width = `${sizePx}px`;
                eChartEl.style.height = `${sizePx}px`;
                eChartEl.style.transform = `rotate(${ROTATION_MAP[direction]}deg)`;
            }

            function generateRandomE(level) {
                const randomDirection = DIRECTIONS[Math.floor(Math.random() * DIRECTIONS.length)];
                return { level, direction: randomDirection };
            }

            function startTest(config) {
                appState.testConfig = config;
                let initialE;
                if (config.type === 'baseline') {
                    initialE = generateRandomE(config.level);
                    timerDisplay.style.display = 'none'; 
                } else { 
                    const levels = [...config.fogLevels, config.minLevel];
                    const randomLevel = levels[Math.floor(Math.random() * levels.length)];
                    initialE = generateRandomE(randomLevel);
                    timerDisplay.style.display = 'block';
                }
                
                const initialTimer = config.type === 'baseline' ? 0 : 60;

                appState.testState = { status: 'running', timer: initialTimer, correct: 0, total: 0, currentE: initialE, type: config.type };
                updateTestUI();
                
                if (config.type === 'fogging') {
                    startTimer();
                }
            }
            
            function startTimer() {
                if (appState.timerInterval) clearInterval(appState.timerInterval);
                appState.timerInterval = setInterval(() => {
                    if (appState.testState.status !== 'running') return;
                    
                    appState.testState.timer--;
                    testTimerEl.textContent = appState.testState.timer;
                    
                    if (appState.testState.timer <= 0) {
                        clearInterval(appState.timerInterval);
                        appState.testState.status = 'paused';
                        showFinalResult();
                    }
                }, 1000);
            }

            function handleAnswer(answer) {
                if (appState.testState.status !== 'running') return;
                const state = appState.testState;
                const config = appState.testConfig;
                
                state.correct += (answer === state.currentE.direction ? 1 : 0);
                state.total += 1;

                if (state.type === 'baseline' && state.total >= 10) {
                    updateTestUI();
                    evaluateBaselineResult();
                    return;
                }

                let nextE;
                if (state.type === 'baseline') {
                    nextE = generateRandomE(config.level);
                } else {
                    const isNextMinLevel = (state.total + 1) % 2 !== 0;
                    const levelToUse = isNextMinLevel ? config.minLevel : config.fogLevels[Math.floor(Math.random() * config.fogLevels.length)];
                    nextE = generateRandomE(levelToUse);
                }
                state.currentE = nextE;
                updateTestUI();
            }

            function evaluateBaselineResult() {
                clearInterval(appState.timerInterval);
                appState.testState.status = 'paused';
                
                const { correct } = appState.testState;
                let title = "基准测试完成";
                let message = `<p>得分: <strong>${correct}/10</strong></p>`;
                
                if (correct >= 8) {
                    message += `<p class="eval-text text-green">✔ 视标合适</p><p>准确率达标，可进行雾视挑战</p>`;
                } else if (correct <= 6) {
                    message += `<p class="eval-text text-red">✘ 建议换大一级</p><p>准确率过低，请调整视标重测。</p>`;
                } else {
                    message += `<p class="eval-text text-yellow">⚠ 建议重测</p><p>处于临界值，建议再测一次。</p>`;
                }
                showFinalResult(title, message);
            }

            function showFinalResult(title = null, customBody = null) {
                clearInterval(appState.timerInterval);
                appState.testState.status = 'paused';
                resultModal.style.display = 'flex';
                
                const { correct, total, type } = appState.testState;
                const config = appState.testConfig;
                const level = type === 'baseline' ? config?.level?.decimal : config?.minLevel?.decimal;
			
                if (!title) {
                    title = type === 'baseline' ? '基准测试完成' : '雾视挑战完成';
                }
                document.getElementById('modal-title').textContent = title;

                if (!customBody) {
                    const accuracy = total > 0 ? ((correct / total) * 100).toFixed(1) : 0;
                    customBody = `<p>测试模式: ${type === 'baseline' ? '基准测定' : '雾视挑战'}</p><p>视标级别: ${level || '-'}</p><p>最终得分: <strong>${correct} / ${total}</strong></p><p>准确率: <strong>${accuracy}%</strong></p>`;
                }
                document.getElementById('modal-body').innerHTML = customBody;

                document.getElementById('modal-btn-continue').style.display = 'none';
                
                const btnEnd = document.getElementById('modal-btn-end');
                btnEnd.textContent = '查看历史';
                btnEnd.className = 'btn bg-blue';
                btnEnd.onclick = () => endTestAndSave();

                document.getElementById('modal-btn-exit').onclick = () => {
                    saveTestRecord();
                    window.location.href = "better_vision.html"; 
                };
		
                setTimeout(() => { focusMenuButton(0); }, 200);
            }

            function showMenu(title = "已暂停", customBody = null, isFinished = false) {
                if (appState.timerInterval) clearInterval(appState.timerInterval);
                if (appState.testState.status === 'running') appState.testState.status = 'paused';

                resultModal.style.display = 'flex';
                document.getElementById('modal-title').textContent = title;
                
                const { correct, total, type } = appState.testState;
                const config = appState.testConfig;
                const level = type === 'baseline' ? config?.level?.decimal : config?.minLevel?.decimal;

                if (customBody) {
                    document.getElementById('modal-body').innerHTML = customBody;
                } else {
                    document.getElementById('modal-body').innerHTML = `<p>当前模式: ${type === 'baseline' ? '基准测试' : '雾视挑战'}</p><p>当前视标: ${level || '-'}</p><p>当前得分: <strong>${correct} / ${total}</strong></p>`;
                }

                const btnEnd = document.getElementById('modal-btn-end');
                btnEnd.textContent = '结束';
                btnEnd.className = 'btn bg-red';
                btnEnd.onclick = () => {
                    saveTestRecord();
                    window.location.href = 'history.html';
                };

                const btnContinue = document.getElementById('modal-btn-continue');
                btnContinue.style.display = 'inline-block';
                btnContinue.onclick = resumeTest;

                document.getElementById('modal-btn-exit').onclick = () => {
                    window.location.href = "better_vision.html"; 
                };
		
                setTimeout(() => { focusMenuButton(1); }, 200);
            }

            function saveTestRecord() {
                const state = appState.testState;
                if (state.total > 0 || state.type === 'baseline') { 
                    let history = JSON.parse(localStorage.getItem('visionHistory') || '[]');
                    const newRecord = { date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), type: state.type === 'baseline' ? '测定基准' : '雾视挑战', level: appState.testConfig?.level?.decimal || appState.testConfig?.minLevel?.decimal, accuracy: state.total > 0 ? (state.correct / state.total) * 100 : 0, score: `${state.correct}/${state.total}` };
                    history.unshift(newRecord);
                    try {
                        localStorage.setItem('visionHistory', JSON.stringify(history));
                    } catch (e) { console.error(e); }
                }
            }

            function resumeTest() {
                resultModal.style.display = 'none';
                appState.testState.status = 'running';
                document.body.focus();
                if (appState.testState.type === 'fogging' && appState.testState.timer > 0) {
                    startTimer();
                }
            }

            function endTestAndSave() {
                saveTestRecord();
                appState.testState.status = 'idle';
                window.location.href = 'history.html';
            }

            function updateTestUI() {
                const { timer, correct, total, currentE, type } = appState.testState;
                const config = appState.testConfig;
                document.getElementById('test-title').textContent = `${type === 'baseline' ? '基准测定' : '雾视挑战'} - ${config?.level?.decimal || config?.minLevel?.decimal || ''}`;
                testTimerEl.textContent = timer;
                testScoreEl.textContent = `${correct}/${total}`;
                if (currentE) renderEChart(currentE.level.sizePx, currentE.direction);
            }

            // --- 焦点管理函数 ---
            function focusMenuButton(index) {
                const buttons = Array.from(document.querySelectorAll('#modal-actions button')).filter(btn => btn.style.display !== 'none');
                if (buttons.length === 0) return;
                const newIndex = (index + buttons.length) % buttons.length;
                buttons[newIndex].focus();
            }

            function focusThemeMenuButton(index) {
                const buttons = Array.from(themeMenu.querySelectorAll('button'));
                if (buttons.length === 0) return;
                const newIndex = (index + buttons.length) % buttons.length;
                buttons[newIndex].focus();
            }

            // --- 事件监听器 ---
            document.getElementById('mobile-btn-menu').onclick = () => showMenu();
            document.querySelectorAll('.touch-btn').forEach(btn => {
                btn.onclick = () => handleAnswer(btn.dataset.dir);
            });

            // --- 遥控器监听 ---
            function handleRemoteControl(key, keyCode, event) {
                const isPauseMenuOpen = resultModal.style.display === 'flex';
                const isThemeMenuOpen = !themeMenu.classList.contains('hidden');

                const isConfirmKey = ['Enter', ' ', 'OK', 'Select', 'Accept'].includes(key) || [13, 23, 66, 108].includes(keyCode);
                const isBackKey = ['Backspace', 'Escape', 'Back'].includes(key) || keyCode === 8 || keyCode === 27;

                if (event) event.preventDefault();

                // 优先级 1: 主题菜单已打开
                if (isThemeMenuOpen) {
                    if (isConfirmKey && document.activeElement.parentElement === themeMenu) {
                        document.activeElement.click();
                        return;
                    }
                    if (isBackKey) {
                        themeMenu.classList.add('hidden');
                        themeToggleBtn.focus();
                        return;
                    }
                    if (key === 'ArrowUp' || key === 'ArrowDown') {
                        const buttons = Array.from(themeMenu.querySelectorAll('button'));
                        let currentIndex = buttons.indexOf(document.activeElement);
                        if (currentIndex === -1) currentIndex = 0;
                        
                        const nextIndex = key === 'ArrowUp' ? currentIndex - 1 : currentIndex + 1;
                        focusThemeMenuButton(nextIndex);
                        return;
                    }
                    return;
                }

                // 优先级 2: 暂停/结果菜单已打开
                if (isPauseMenuOpen) {
                    if (isConfirmKey && document.activeElement.closest('#modal-actions')) {
                        document.activeElement.click();
                        return;
                    }
                    if (isBackKey) {
                        const continueBtn = document.getElementById('modal-btn-continue');
                        if (continueBtn.style.display !== 'none') {
                            continueBtn.click();
                        } else {
                            document.getElementById('modal-btn-exit').click();
                        }
                        return;
                    }
                    if (['ArrowUp', 'ArrowLeft', 'ArrowDown', 'ArrowRight'].includes(key)) {
                        const buttons = Array.from(document.querySelectorAll('#modal-actions button')).filter(b => b.style.display !== 'none');
                        let currentIndex = buttons.indexOf(document.activeElement);
                        const direction = (key === 'ArrowUp' || key === 'ArrowLeft') ? -1 : 1;
                        focusMenuButton(currentIndex + direction);
                        return;
                    }
                    return;
                }

                // 优先级 3: 正常测试中
                if (isConfirmKey) {
                    if (document.activeElement === themeToggleBtn) {
                        themeToggleBtn.click();
                    } else {
                        showMenu();
                    }
                    return;
                }

                if (KEY_MAP[key]) {
                    handleAnswer(KEY_MAP[key]);
                }
            }

            window.addEventListener('keydown', (e) => {
                const keyCode = e.keyCode || e.which;
                handleRemoteControl(e.key, keyCode, e);
            });

            // --- 初始化 ---
            function initialize() {
                const storedConfig = localStorage.getItem('testConfig');
                if (storedConfig) {
                    try {
                        const config = JSON.parse(storedConfig);
                        startTest(config);
                    } catch (e) {
                        console.error("Config parse error", e);
                        window.location.href = 'index.html';
                    }
                } else {
                    window.location.href = 'index.html';
                }
            }

            initialize();
        });
    </script>

    <!-- 引入您已修改好的 theme.js 文件 -->
    <script src="theme.js"></script>
    
</body>
</html>